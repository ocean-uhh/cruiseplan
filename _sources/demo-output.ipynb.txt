{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "intro",
   "metadata": {},
   "source": [
    "# CruisePlan Demo \n",
    "\n",
    "This notebook demonstrates the complete CruisePlan workflow using Python functions rather than CLI commands. Each section corresponds to a CLI subcommand and shows how to accomplish the same tasks programmatically.\n",
    "\n",
    "## Workflow Overview\n",
    "\n",
    "1. **Download**: Get bathymetry data for depth calculations\n",
    "2. **Pandoi**: Search PANGAEA database for relevant oceanographic datasets\n",
    "3. **Pangaea**: Process DOI list into campaign dataset\n",
    "4. **Stations**: Interactive station planning (or programmatic configuration)\n",
    "5. **Validate**: Check configuration for errors and warnings\n",
    "6. **Enrich**: Add computed data (depths, coordinates, expand sections)\n",
    "7. **Map**: Create visualization maps\n",
    "8. **Schedule**: Generate cruise timeline and outputs\n",
    "\n",
    "All outputs will be saved to `tests_output/demo/` for easy exploration."
   ]
  },
  {
   "cell_type": "markdown",
   "id": "setup",
   "metadata": {},
   "source": [
    "## Setup and Imports"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "setup-imports",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-12-19T22:23:50.567875Z",
     "iopub.status.busy": "2025-12-19T22:23:50.567682Z",
     "iopub.status.idle": "2025-12-19T22:23:52.559380Z",
     "shell.execute_reply": "2025-12-19T22:23:52.558601Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Demo outputs will be saved to: /home/runner/work/cruiseplan/cruiseplan/notebooks/../tests_output/demo\n"
     ]
    }
   ],
   "source": [
    "# Core imports\n",
    "import logging\n",
    "from pathlib import Path\n",
    "\n",
    "import xarray as xr\n",
    "\n",
    "from cruiseplan.calculators.scheduler import generate_cruise_schedule\n",
    "from cruiseplan.core.cruise import Cruise\n",
    "from cruiseplan.core.validation import enrich_configuration\n",
    "from cruiseplan.data.bathymetry import BathymetryManager\n",
    "from cruiseplan.data.pangaea import PangaeaManager, save_campaign_data\n",
    "from cruiseplan.output.map_generator import generate_map_from_yaml\n",
    "from cruiseplan.utils.yaml_io import save_yaml\n",
    "\n",
    "# Set up output directory\n",
    "output_dir = Path('../tests_output/demo')\n",
    "output_dir.mkdir(parents=True, exist_ok=True)\n",
    "\n",
    "print(f\"Demo outputs will be saved to: {output_dir.absolute()}\")\n",
    "\n",
    "# Configure logging to see what's happening\n",
    "logging.basicConfig(level=logging.INFO, format='%(levelname)s: %(message)s')"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "step1-header",
   "metadata": {},
   "source": [
    "## Step 1: Download Bathymetry Data\n",
    "\n",
    "**CLI Equivalent**: `cruiseplan download --bathymetry-source etopo2022`\n",
    "\n",
    "First, we need bathymetry data for depth calculations and visualization."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "step1-download",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-12-19T22:23:52.561207Z",
     "iopub.status.busy": "2025-12-19T22:23:52.560883Z",
     "iopub.status.idle": "2025-12-19T22:23:52.568237Z",
     "shell.execute_reply": "2025-12-19T22:23:52.567450Z"
    }
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO: ‚ö†Ô∏è No bathymetry file found at /home/runner/work/cruiseplan/cruiseplan/data/bathymetry/ETOPO_2022_v1_60s_N90W180_bed.nc. Using MOCK mode.\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:    Run `cruiseplan.data.bathymetry.download_bathymetry()` to fetch it.\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "üì• Downloading bathymetry data...\n"
     ]
    }
   ],
   "source": [
    "# Initialize bathymetry manager with ETOPO2022 data\n",
    "print(\"üì• Downloading bathymetry data...\")\n",
    "bathymetry = BathymetryManager(source=\"etopo2022\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "step2-header",
   "metadata": {},
   "source": [
    "## Step 2: Search PANGAEA Database\n",
    "\n",
    "**CLI Equivalent**: `cruiseplan pandoi \"CTD temperature\" --lat 50 70 --lon -60 -30 --limit 15`\n",
    "\n",
    "Search for relevant oceanographic datasets to inform our cruise planning."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "step2-pandoi",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-12-19T22:23:52.569761Z",
     "iopub.status.busy": "2025-12-19T22:23:52.569606Z",
     "iopub.status.idle": "2025-12-19T22:24:02.760260Z",
     "shell.execute_reply": "2025-12-19T22:24:02.759451Z"
    }
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO: Searching Pangaea: 'CTD' (Limit: 5)\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "üîç Searching PANGAEA database...\n",
      "   Query: 'CTD'\n",
      "   Geographic bounds: 50¬∞N-70¬∞N, 60¬∞W-30¬∞W\n",
      "   Limit: 5 datasets\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO: Search found 1823 total matches. Retrieving first 5...\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO: Fetching PANGAEA dataset: 10.1594/PANGAEA.755512\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO: Fetching PANGAEA dataset: 10.1594/PANGAEA.604878\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO: Fetching PANGAEA dataset: 10.1594/PANGAEA.604842\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO: Fetching PANGAEA dataset: 10.1594/PANGAEA.604887\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO: Fetching PANGAEA dataset: 10.1594/PANGAEA.604857\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "‚úÖ Found 5 datasets\n",
      "   DOI list saved to: ../tests_output/demo/demo_dois.txt\n",
      "   First few DOIs: ['10.1594/PANGAEA.755512', '10.1594/PANGAEA.604878', '10.1594/PANGAEA.604842']\n"
     ]
    }
   ],
   "source": [
    "print(\"üîç Searching PANGAEA database...\")\n",
    "\n",
    "# Initialize PANGAEA manager\n",
    "pangaea_mgr = PangaeaManager()\n",
    "\n",
    "# Define search parameters\n",
    "query = \"CTD\" # or \"CTD temperature North Atlantic\"\n",
    "bbox = (-60, 50, -30, 70)  # (min_lon, min_lat, max_lon, max_lat)\n",
    "limit = 5\n",
    "\n",
    "print(f\"   Query: '{query}'\")\n",
    "print(\"   Geographic bounds: 50¬∞N-70¬∞N, 60¬∞W-30¬∞W\")\n",
    "print(f\"   Limit: {limit} datasets\")\n",
    "\n",
    "# Perform search\n",
    "try:\n",
    "    datasets = pangaea_mgr.search(query=query, bbox=bbox, limit=limit)\n",
    "    print(f\"‚úÖ Found {len(datasets)} datasets\")\n",
    "\n",
    "    # Extract DOIs and save to file\n",
    "    dois = [ds.get('doi') for ds in datasets if ds.get('doi')]\n",
    "\n",
    "    # Save DOI list\n",
    "    doi_file = output_dir / \"demo_dois.txt\"\n",
    "    with open(doi_file, 'w') as f:\n",
    "        for doi in dois:\n",
    "            f.write(f\"{doi}\\n\")\n",
    "\n",
    "    print(f\"   DOI list saved to: {doi_file}\")\n",
    "    print(f\"   First few DOIs: {dois[:3]}\")\n",
    "\n",
    "except Exception as e:\n",
    "    print(f\"‚ùå Search failed: {e}\")\n",
    "    # Create a minimal DOI list for demo purposes\n",
    "    doi_file = output_dir / \"demo_dois.txt\"\n",
    "    with open(doi_file, 'w') as f:\n",
    "        f.write(\"10.1594/PANGAEA.123456\\n\")\n",
    "    print(f\"   Created minimal DOI file for demo: {doi_file}\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "step3-header",
   "metadata": {},
   "source": [
    "## Step 3: Process PANGAEA Campaigns\n",
    "\n",
    "**CLI Equivalent**: `cruiseplan pangaea demo_dois.txt -o tests_output/demo/`\n",
    "\n",
    "Process the DOI list to extract campaign coordinates and metadata."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "step3-pangaea",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-12-19T22:24:02.761865Z",
     "iopub.status.busy": "2025-12-19T22:24:02.761698Z",
     "iopub.status.idle": "2025-12-19T22:24:06.767477Z",
     "shell.execute_reply": "2025-12-19T22:24:06.766762Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "üìä Processing 5 PANGAEA DOIs...\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "‚úÖ Saved 2 campaign tracks to ../tests_output/demo/ctd_pangaea_data.pkl\n"
     ]
    }
   ],
   "source": [
    "# Read the DOI list\n",
    "with open(output_dir / \"demo_dois.txt\") as f:\n",
    "    dois = [line.strip() for line in f if line.strip()]\n",
    "\n",
    "print(f\"üìä Processing {len(dois)} PANGAEA DOIs...\")\n",
    "\n",
    "# Create manager and fetch datasets\n",
    "manager = PangaeaManager()\n",
    "datasets = manager.fetch_datasets(\n",
    "    doi_list=dois,\n",
    "    rate_limit=1.0,\n",
    "    merge_campaigns=True\n",
    ")\n",
    "\n",
    "\n",
    "if datasets:\n",
    "    # Save using the CLI's save function\n",
    "    output_file = Path(output_dir / \"ctd_pangaea_data.pkl\")\n",
    "    save_campaign_data(datasets, output_file)\n",
    "    print(f\"‚úÖ Saved {len(datasets)} campaign tracks to {output_file}\")\n",
    "else:\n",
    "    print(\"‚ö†Ô∏è No datasets retrieved\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "step4-header",
   "metadata": {},
   "source": [
    "## Step 4: Create Station Configuration\n",
    "\n",
    "**CLI Equivalent**: `cruiseplan stations --pangaea-file campaigns.pkl --lat 50 70 --lon -60 -30`\n",
    "\n",
    "For this demo, we'll create a programmatic station configuration rather than using the interactive interface."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "step4-stations",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-12-19T22:24:06.769210Z",
     "iopub.status.busy": "2025-12-19T22:24:06.769044Z",
     "iopub.status.idle": "2025-12-19T22:24:06.784650Z",
     "shell.execute_reply": "2025-12-19T22:24:06.784084Z"
    }
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO: Saved configuration to: ../tests_output/demo/demo_cruise.yaml\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "üó∫Ô∏è  Creating station configuration...\n",
      "‚úÖ Station configuration created\n",
      "   Configuration saved to: ../tests_output/demo/demo_cruise.yaml\n",
      "   Stations: 7\n",
      "   Transits: 1\n",
      "   Legs: 2\n"
     ]
    }
   ],
   "source": [
    "print(\"üó∫Ô∏è  Creating station configuration...\")\n",
    "\n",
    "# Create a sample cruise configuration\n",
    "cruise_config = {\n",
    "    'cruise_name': 'Demo North Atlantic Survey 2025',\n",
    "    'description': 'Demonstration cruise for CruisePlan workflow',\n",
    "    'default_vessel_speed': 10.0,\n",
    "    'turnaround_time': 30.0,\n",
    "    'ctd_descent_rate': 1.0,\n",
    "    'ctd_ascent_rate': 1.0,\n",
    "    'calculate_transfer_between_sections': True,\n",
    "    'calculate_depth_via_bathymetry': True,\n",
    "    'start_date': '2025-06-01T00:00:00Z',\n",
    "    'departure_port': {\n",
    "        'name': 'St. Johns',\n",
    "        'position': {\n",
    "            'latitude': 47.5615,\n",
    "            'longitude': -52.7126\n",
    "        }\n",
    "    },\n",
    "    'arrival_port': {\n",
    "        'name': 'St. Johns',\n",
    "        'position': {\n",
    "            'latitude': 47.5615,\n",
    "            'longitude': -52.7126\n",
    "        }\n",
    "    },\n",
    "    'first_station': 'STN_001',\n",
    "    'last_station': 'STN_006',\n",
    "\n",
    "    # Define stations along a transect\n",
    "    'stations': [\n",
    "        {\n",
    "            'name': 'STN_001',\n",
    "            'position': {'latitude': 55.0, 'longitude': -50.0},\n",
    "            'operation_type': 'CTD',\n",
    "            'action': 'profile',\n",
    "            'comment': 'Continental shelf station'\n",
    "        },\n",
    "        {\n",
    "            'name': 'STN_002',\n",
    "            'position': {'latitude': 57.0, 'longitude': -45.0},\n",
    "            'operation_type': 'CTD',\n",
    "            'action': 'profile',\n",
    "            'comment': 'Slope station'\n",
    "        },\n",
    "        {\n",
    "            'name': 'STN_003',\n",
    "            'position': {'latitude': 59.0, 'longitude': -40.0},\n",
    "            'operation_type': 'CTD',\n",
    "            'action': 'profile',\n",
    "            'comment': 'Deep water station'\n",
    "        },\n",
    "        {\n",
    "            'name': 'STN_004',\n",
    "            'position': {'latitude': 61.0, 'longitude': -35.0},\n",
    "            'operation_type': 'water_sampling',\n",
    "            'action': 'sampling',\n",
    "            'duration': 180.0,\n",
    "            'comment': 'Water sampling station'\n",
    "        },\n",
    "        {\n",
    "            'name': 'MOOR_001',\n",
    "            'position': {'latitude': 60.5, 'longitude': -38.0},\n",
    "            'operation_type': 'mooring',\n",
    "            'action': 'deployment',\n",
    "            'duration': 240.0,\n",
    "            'delay_start': 60.0,  # Wait for daylight\n",
    "            'comment': 'Mooring deployment'\n",
    "        },\n",
    "        {\n",
    "            'name': 'STN_005',\n",
    "            'position': {'latitude': 63.0, 'longitude': -30.0},\n",
    "            'operation_type': 'CTD',\n",
    "            'action': 'profile',\n",
    "            'comment': 'Northern end station'\n",
    "        },\n",
    "        {\n",
    "            'name': 'STN_006',\n",
    "            'position': {'latitude': 58.0, 'longitude': -42.0},\n",
    "            'operation_type': 'CTD',\n",
    "            'action': 'profile',\n",
    "            'comment': 'Return transect station'\n",
    "        }\n",
    "    ],\n",
    "\n",
    "    # Add a CTD section that can be expanded\n",
    "    'transits': [\n",
    "        {\n",
    "            'name': 'Demo_CTD_Section',\n",
    "            'operation_type': 'CTD',\n",
    "            'action': 'section',\n",
    "            'route': [\n",
    "                {'latitude': 56.0, 'longitude': -48.0},\n",
    "                {'latitude': 56.0, 'longitude': -38.0}\n",
    "            ],\n",
    "            'comment': 'Zonal CTD section for expansion'\n",
    "        }\n",
    "    ],\n",
    "\n",
    "    # Define execution order\n",
    "    'legs': [\n",
    "        {\n",
    "            'name': 'Outbound_Survey',\n",
    "            'description': 'Outbound transect with mooring deployment',\n",
    "            'buffer_time': 120.0,  # 2h weather contingency\n",
    "            'strategy': 'sequential',\n",
    "            'sequence': ['STN_001', 'STN_002', 'STN_003', 'STN_004', 'MOOR_001', 'STN_005'],\n",
    "            'transits': ['Demo_CTD_Section']\n",
    "        },\n",
    "        {\n",
    "            'name': 'Return_Survey',\n",
    "            'description': 'Return transect',\n",
    "            'sequence': ['STN_006']\n",
    "        }\n",
    "    ]\n",
    "}\n",
    "\n",
    "# Save configuration\n",
    "config_file = output_dir / \"demo_cruise.yaml\"\n",
    "save_yaml(cruise_config, config_file)\n",
    "\n",
    "print(\"‚úÖ Station configuration created\")\n",
    "print(f\"   Configuration saved to: {config_file}\")\n",
    "print(f\"   Stations: {len(cruise_config['stations'])}\")\n",
    "print(f\"   Transits: {len(cruise_config['transits'])}\")\n",
    "print(f\"   Legs: {len(cruise_config['legs'])}\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "step5-header",
   "metadata": {},
   "source": [
    "## Step 5: Validate Configuration\n",
    "\n",
    "**CLI Equivalent**: `cruiseplan validate -c demo_cruise.yaml --check-depths`\n",
    "\n",
    "Check the configuration for errors and potential issues."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "step5-validate",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-12-19T22:24:06.786238Z",
     "iopub.status.busy": "2025-12-19T22:24:06.786087Z",
     "iopub.status.idle": "2025-12-19T22:24:07.026826Z",
     "shell.execute_reply": "2025-12-19T22:24:07.025968Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "‚úÖ Validating configuration...\n"
     ]
    },
    {
     "ename": "ValidationError",
     "evalue": "12 validation errors for CruiseConfig\ndeparture_port.str\n  Input should be a valid string [type=string_type, input_value={'name': 'St. Johns', 'po... 'longitude': -52.7126}}, input_type=CommentedMap]\n    For further information visit https://errors.pydantic.dev/2.12/v/string_type\ndeparture_port.PortDefinition.latitude\n  Field required [type=missing, input_value={'name': 'St. Johns', 'po... 'longitude': -52.7126}}, input_type=CommentedMap]\n    For further information visit https://errors.pydantic.dev/2.12/v/missing\ndeparture_port.PortDefinition.longitude\n  Field required [type=missing, input_value={'name': 'St. Johns', 'po... 'longitude': -52.7126}}, input_type=CommentedMap]\n    For further information visit https://errors.pydantic.dev/2.12/v/missing\narrival_port.str\n  Input should be a valid string [type=string_type, input_value={'name': 'St. Johns', 'po... 'longitude': -52.7126}}, input_type=CommentedMap]\n    For further information visit https://errors.pydantic.dev/2.12/v/string_type\narrival_port.PortDefinition.latitude\n  Field required [type=missing, input_value={'name': 'St. Johns', 'po... 'longitude': -52.7126}}, input_type=CommentedMap]\n    For further information visit https://errors.pydantic.dev/2.12/v/missing\narrival_port.PortDefinition.longitude\n  Field required [type=missing, input_value={'name': 'St. Johns', 'po... 'longitude': -52.7126}}, input_type=CommentedMap]\n    For further information visit https://errors.pydantic.dev/2.12/v/missing\nlegs.0.departure_port\n  Field required [type=missing, input_value={'name': 'Outbound_Survey...': ['Demo_CTD_Section']}, input_type=CommentedMap]\n    For further information visit https://errors.pydantic.dev/2.12/v/missing\nlegs.0.arrival_port\n  Field required [type=missing, input_value={'name': 'Outbound_Survey...': ['Demo_CTD_Section']}, input_type=CommentedMap]\n    For further information visit https://errors.pydantic.dev/2.12/v/missing\nlegs.1.departure_port\n  Field required [type=missing, input_value={'name': 'Return_Survey',...'sequence': ['STN_006']}, input_type=CommentedMap]\n    For further information visit https://errors.pydantic.dev/2.12/v/missing\nlegs.1.arrival_port\n  Field required [type=missing, input_value={'name': 'Return_Survey',...'sequence': ['STN_006']}, input_type=CommentedMap]\n    For further information visit https://errors.pydantic.dev/2.12/v/missing\nfirst_station\n  Extra inputs are not permitted [type=extra_forbidden, input_value='STN_001', input_type=str]\n    For further information visit https://errors.pydantic.dev/2.12/v/extra_forbidden\nlast_station\n  Extra inputs are not permitted [type=extra_forbidden, input_value='STN_006', input_type=str]\n    For further information visit https://errors.pydantic.dev/2.12/v/extra_forbidden",
     "output_type": "error",
     "traceback": [
      "\u001b[31m---------------------------------------------------------------------------\u001b[39m",
      "\u001b[31mValidationError\u001b[39m                           Traceback (most recent call last)",
      "\u001b[36mCell\u001b[39m\u001b[36m \u001b[39m\u001b[32mIn[6]\u001b[39m\u001b[32m, line 4\u001b[39m\n\u001b[32m      1\u001b[39m \u001b[38;5;28mprint\u001b[39m(\u001b[33m\"\u001b[39m\u001b[33m‚úÖ Validating configuration...\u001b[39m\u001b[33m\"\u001b[39m)\n\u001b[32m      3\u001b[39m config_file = output_dir / \u001b[33m\"\u001b[39m\u001b[33mdemo_cruise.yaml\u001b[39m\u001b[33m\"\u001b[39m\n\u001b[32m----> \u001b[39m\u001b[32m4\u001b[39m cruise = \u001b[43mCruise\u001b[49m\u001b[43m(\u001b[49m\u001b[43mconfig_file\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m      6\u001b[39m \u001b[38;5;66;03m# The Cruise.__init__() automatically performs validation during loading\u001b[39;00m\n\u001b[32m      7\u001b[39m \u001b[38;5;66;03m# including Pydantic model validation and cruise-specific validation\u001b[39;00m\n\u001b[32m      8\u001b[39m \u001b[38;5;28mprint\u001b[39m(\u001b[33m\"\u001b[39m\u001b[33m‚úÖ Configuration loaded and validated successfully!\u001b[39m\u001b[33m\"\u001b[39m)\n",
      "\u001b[36mFile \u001b[39m\u001b[32m~/work/cruiseplan/cruiseplan/cruiseplan/core/cruise.py:84\u001b[39m, in \u001b[36mCruise.__init__\u001b[39m\u001b[34m(self, config_path)\u001b[39m\n\u001b[32m     81\u001b[39m \u001b[38;5;28mself\u001b[39m.raw_data = \u001b[38;5;28mself\u001b[39m._load_yaml()\n\u001b[32m     83\u001b[39m \u001b[38;5;66;03m# 1. Validation Pass (Pydantic)\u001b[39;00m\n\u001b[32m---> \u001b[39m\u001b[32m84\u001b[39m \u001b[38;5;28mself\u001b[39m.config = \u001b[43mCruiseConfig\u001b[49m\u001b[43m(\u001b[49m\u001b[43m*\u001b[49m\u001b[43m*\u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mraw_data\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m     86\u001b[39m \u001b[38;5;66;03m# 2. Indexing Pass (Build the Catalog Registry)\u001b[39;00m\n\u001b[32m     87\u001b[39m \u001b[38;5;28mself\u001b[39m.station_registry: Dict[\u001b[38;5;28mstr\u001b[39m, StationDefinition] = {\n\u001b[32m     88\u001b[39m     s.name: s \u001b[38;5;28;01mfor\u001b[39;00m s \u001b[38;5;129;01min\u001b[39;00m (\u001b[38;5;28mself\u001b[39m.config.stations \u001b[38;5;129;01mor\u001b[39;00m [])\n\u001b[32m     89\u001b[39m }\n",
      "\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/cruiseplan/lib/python3.13/site-packages/pydantic/main.py:250\u001b[39m, in \u001b[36mBaseModel.__init__\u001b[39m\u001b[34m(self, **data)\u001b[39m\n\u001b[32m    248\u001b[39m \u001b[38;5;66;03m# `__tracebackhide__` tells pytest and some other tools to omit this function from tracebacks\u001b[39;00m\n\u001b[32m    249\u001b[39m __tracebackhide__ = \u001b[38;5;28;01mTrue\u001b[39;00m\n\u001b[32m--> \u001b[39m\u001b[32m250\u001b[39m validated_self = \u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43m__pydantic_validator__\u001b[49m\u001b[43m.\u001b[49m\u001b[43mvalidate_python\u001b[49m\u001b[43m(\u001b[49m\u001b[43mdata\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mself_instance\u001b[49m\u001b[43m=\u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m)\u001b[49m\n\u001b[32m    251\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m \u001b[38;5;28mself\u001b[39m \u001b[38;5;129;01mis\u001b[39;00m \u001b[38;5;129;01mnot\u001b[39;00m validated_self:\n\u001b[32m    252\u001b[39m     warnings.warn(\n\u001b[32m    253\u001b[39m         \u001b[33m'\u001b[39m\u001b[33mA custom validator is returning a value other than `self`.\u001b[39m\u001b[38;5;130;01m\\n\u001b[39;00m\u001b[33m'\u001b[39m\n\u001b[32m    254\u001b[39m         \u001b[33m\"\u001b[39m\u001b[33mReturning anything other than `self` from a top level model validator isn\u001b[39m\u001b[33m'\u001b[39m\u001b[33mt supported when validating via `__init__`.\u001b[39m\u001b[38;5;130;01m\\n\u001b[39;00m\u001b[33m\"\u001b[39m\n\u001b[32m    255\u001b[39m         \u001b[33m'\u001b[39m\u001b[33mSee the `model_validator` docs (https://docs.pydantic.dev/latest/concepts/validators/#model-validators) for more details.\u001b[39m\u001b[33m'\u001b[39m,\n\u001b[32m    256\u001b[39m         stacklevel=\u001b[32m2\u001b[39m,\n\u001b[32m    257\u001b[39m     )\n",
      "\u001b[31mValidationError\u001b[39m: 12 validation errors for CruiseConfig\ndeparture_port.str\n  Input should be a valid string [type=string_type, input_value={'name': 'St. Johns', 'po... 'longitude': -52.7126}}, input_type=CommentedMap]\n    For further information visit https://errors.pydantic.dev/2.12/v/string_type\ndeparture_port.PortDefinition.latitude\n  Field required [type=missing, input_value={'name': 'St. Johns', 'po... 'longitude': -52.7126}}, input_type=CommentedMap]\n    For further information visit https://errors.pydantic.dev/2.12/v/missing\ndeparture_port.PortDefinition.longitude\n  Field required [type=missing, input_value={'name': 'St. Johns', 'po... 'longitude': -52.7126}}, input_type=CommentedMap]\n    For further information visit https://errors.pydantic.dev/2.12/v/missing\narrival_port.str\n  Input should be a valid string [type=string_type, input_value={'name': 'St. Johns', 'po... 'longitude': -52.7126}}, input_type=CommentedMap]\n    For further information visit https://errors.pydantic.dev/2.12/v/string_type\narrival_port.PortDefinition.latitude\n  Field required [type=missing, input_value={'name': 'St. Johns', 'po... 'longitude': -52.7126}}, input_type=CommentedMap]\n    For further information visit https://errors.pydantic.dev/2.12/v/missing\narrival_port.PortDefinition.longitude\n  Field required [type=missing, input_value={'name': 'St. Johns', 'po... 'longitude': -52.7126}}, input_type=CommentedMap]\n    For further information visit https://errors.pydantic.dev/2.12/v/missing\nlegs.0.departure_port\n  Field required [type=missing, input_value={'name': 'Outbound_Survey...': ['Demo_CTD_Section']}, input_type=CommentedMap]\n    For further information visit https://errors.pydantic.dev/2.12/v/missing\nlegs.0.arrival_port\n  Field required [type=missing, input_value={'name': 'Outbound_Survey...': ['Demo_CTD_Section']}, input_type=CommentedMap]\n    For further information visit https://errors.pydantic.dev/2.12/v/missing\nlegs.1.departure_port\n  Field required [type=missing, input_value={'name': 'Return_Survey',...'sequence': ['STN_006']}, input_type=CommentedMap]\n    For further information visit https://errors.pydantic.dev/2.12/v/missing\nlegs.1.arrival_port\n  Field required [type=missing, input_value={'name': 'Return_Survey',...'sequence': ['STN_006']}, input_type=CommentedMap]\n    For further information visit https://errors.pydantic.dev/2.12/v/missing\nfirst_station\n  Extra inputs are not permitted [type=extra_forbidden, input_value='STN_001', input_type=str]\n    For further information visit https://errors.pydantic.dev/2.12/v/extra_forbidden\nlast_station\n  Extra inputs are not permitted [type=extra_forbidden, input_value='STN_006', input_type=str]\n    For further information visit https://errors.pydantic.dev/2.12/v/extra_forbidden"
     ]
    }
   ],
   "source": [
    "print(\"‚úÖ Validating configuration...\")\n",
    "\n",
    "config_file = output_dir / \"demo_cruise.yaml\"\n",
    "cruise = Cruise(config_file)\n",
    "\n",
    "# The Cruise.__init__() automatically performs validation during loading\n",
    "# including Pydantic model validation and cruise-specific validation\n",
    "print(\"‚úÖ Configuration loaded and validated successfully!\")\n",
    "print(f\"   - Found {len(cruise.station_registry)} station definitions\")\n",
    "print(f\"   - Found {len(cruise.config.legs or [])} leg definitions\")\n",
    "if hasattr(cruise.config, 'transits') and cruise.config.transits:\n",
    "    print(f\"   - Found {len(cruise.config.transits)} transit definitions\")\n",
    "if hasattr(cruise.config, 'schedule') and cruise.config.schedule:\n",
    "    print(f\"   - Found {len(cruise.config.schedule)} scheduled items\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "step6-header",
   "metadata": {},
   "source": [
    "## Step 6: Enrich Configuration\n",
    "\n",
    "**CLI Equivalent**: `cruiseplan enrich -c demo_cruise.yaml --add-depths --add-coords --expand-sections`\n",
    "\n",
    "Add computed data like depths, formatted coordinates, and expand CTD sections."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "step6-enrich",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-12-19T22:24:07.028520Z",
     "iopub.status.busy": "2025-12-19T22:24:07.028335Z",
     "iopub.status.idle": "2025-12-19T22:24:07.257031Z",
     "shell.execute_reply": "2025-12-19T22:24:07.256136Z"
    }
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "WARNING: ‚ö†Ô∏è Added missing field: default_distance_between_stations = 15.0 km\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO: ‚ÑπÔ∏è Missing required fields added with defaults. Update these values as needed.\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO: Expanded 'Demo_CTD_Section' into 32 stations\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO: Saved configuration to: /tmp/tmpoed44_6p.yaml\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "üîß Enriching configuration...\n"
     ]
    },
    {
     "ename": "ValidationError",
     "evalue": "12 validation errors for CruiseConfig\ndeparture_port.str\n  Input should be a valid string [type=string_type, input_value={'name': 'St. Johns', 'po... 'longitude': -52.7126}}, input_type=CommentedMap]\n    For further information visit https://errors.pydantic.dev/2.12/v/string_type\ndeparture_port.PortDefinition.latitude\n  Field required [type=missing, input_value={'name': 'St. Johns', 'po... 'longitude': -52.7126}}, input_type=CommentedMap]\n    For further information visit https://errors.pydantic.dev/2.12/v/missing\ndeparture_port.PortDefinition.longitude\n  Field required [type=missing, input_value={'name': 'St. Johns', 'po... 'longitude': -52.7126}}, input_type=CommentedMap]\n    For further information visit https://errors.pydantic.dev/2.12/v/missing\narrival_port.str\n  Input should be a valid string [type=string_type, input_value={'name': 'St. Johns', 'po... 'longitude': -52.7126}}, input_type=CommentedMap]\n    For further information visit https://errors.pydantic.dev/2.12/v/string_type\narrival_port.PortDefinition.latitude\n  Field required [type=missing, input_value={'name': 'St. Johns', 'po... 'longitude': -52.7126}}, input_type=CommentedMap]\n    For further information visit https://errors.pydantic.dev/2.12/v/missing\narrival_port.PortDefinition.longitude\n  Field required [type=missing, input_value={'name': 'St. Johns', 'po... 'longitude': -52.7126}}, input_type=CommentedMap]\n    For further information visit https://errors.pydantic.dev/2.12/v/missing\nlegs.0.departure_port\n  Field required [type=missing, input_value={'name': 'Outbound_Survey...': ['Demo_CTD_Section']}, input_type=CommentedMap]\n    For further information visit https://errors.pydantic.dev/2.12/v/missing\nlegs.0.arrival_port\n  Field required [type=missing, input_value={'name': 'Outbound_Survey...': ['Demo_CTD_Section']}, input_type=CommentedMap]\n    For further information visit https://errors.pydantic.dev/2.12/v/missing\nlegs.1.departure_port\n  Field required [type=missing, input_value={'name': 'Return_Survey',...'sequence': ['STN_006']}, input_type=CommentedMap]\n    For further information visit https://errors.pydantic.dev/2.12/v/missing\nlegs.1.arrival_port\n  Field required [type=missing, input_value={'name': 'Return_Survey',...'sequence': ['STN_006']}, input_type=CommentedMap]\n    For further information visit https://errors.pydantic.dev/2.12/v/missing\nfirst_station\n  Extra inputs are not permitted [type=extra_forbidden, input_value='STN_001', input_type=str]\n    For further information visit https://errors.pydantic.dev/2.12/v/extra_forbidden\nlast_station\n  Extra inputs are not permitted [type=extra_forbidden, input_value='STN_006', input_type=str]\n    For further information visit https://errors.pydantic.dev/2.12/v/extra_forbidden",
     "output_type": "error",
     "traceback": [
      "\u001b[31m---------------------------------------------------------------------------\u001b[39m",
      "\u001b[31mValidationError\u001b[39m                           Traceback (most recent call last)",
      "\u001b[36mCell\u001b[39m\u001b[36m \u001b[39m\u001b[32mIn[7]\u001b[39m\u001b[32m, line 7\u001b[39m\n\u001b[32m      4\u001b[39m enriched_config_file = output_dir / \u001b[33m\"\u001b[39m\u001b[33mdemo_cruise_enriched.yaml\u001b[39m\u001b[33m\"\u001b[39m\n\u001b[32m      6\u001b[39m \u001b[38;5;66;03m# Use the actual enrichment function\u001b[39;00m\n\u001b[32m----> \u001b[39m\u001b[32m7\u001b[39m summary = \u001b[43menrich_configuration\u001b[49m\u001b[43m(\u001b[49m\n\u001b[32m      8\u001b[39m \u001b[43m    \u001b[49m\u001b[43mconfig_path\u001b[49m\u001b[43m=\u001b[49m\u001b[43mconfig_file\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m      9\u001b[39m \u001b[43m    \u001b[49m\u001b[43madd_depths\u001b[49m\u001b[43m=\u001b[49m\u001b[38;5;28;43;01mTrue\u001b[39;49;00m\u001b[43m,\u001b[49m\n\u001b[32m     10\u001b[39m \u001b[43m    \u001b[49m\u001b[43madd_coords\u001b[49m\u001b[43m=\u001b[49m\u001b[38;5;28;43;01mTrue\u001b[39;49;00m\u001b[43m,\u001b[49m\n\u001b[32m     11\u001b[39m \u001b[43m    \u001b[49m\u001b[43mexpand_sections\u001b[49m\u001b[43m=\u001b[49m\u001b[38;5;28;43;01mTrue\u001b[39;49;00m\u001b[43m,\u001b[49m\n\u001b[32m     12\u001b[39m \u001b[43m    \u001b[49m\u001b[43mbathymetry_source\u001b[49m\u001b[43m=\u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43metopo2022\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m,\u001b[49m\n\u001b[32m     13\u001b[39m \u001b[43m    \u001b[49m\u001b[43mcoord_format\u001b[49m\u001b[43m=\u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43mdmm\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m,\u001b[49m\n\u001b[32m     14\u001b[39m \u001b[43m    \u001b[49m\u001b[43moutput_path\u001b[49m\u001b[43m=\u001b[49m\u001b[43menriched_config_file\u001b[49m\n\u001b[32m     15\u001b[39m \u001b[43m)\u001b[49m\n\u001b[32m     17\u001b[39m \u001b[38;5;28mprint\u001b[39m(\u001b[33mf\u001b[39m\u001b[33m\"\u001b[39m\u001b[33m‚úÖ Configuration enriched and saved to \u001b[39m\u001b[38;5;132;01m{\u001b[39;00menriched_config_file\u001b[38;5;132;01m}\u001b[39;00m\u001b[33m\"\u001b[39m)\n\u001b[32m     18\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m summary:\n",
      "\u001b[36mFile \u001b[39m\u001b[32m~/work/cruiseplan/cruiseplan/cruiseplan/core/validation.py:2623\u001b[39m, in \u001b[36menrich_configuration\u001b[39m\u001b[34m(config_path, add_depths, add_coords, expand_sections, expand_ports, bathymetry_source, bathymetry_dir, coord_format, output_path)\u001b[39m\n\u001b[32m   2621\u001b[39m     save_yaml(config_dict, temp_config_path, backup=\u001b[38;5;28;01mFalse\u001b[39;00m)\n\u001b[32m   2622\u001b[39m     \u001b[38;5;66;03m# Load cruise configuration from preprocessed data\u001b[39;00m\n\u001b[32m-> \u001b[39m\u001b[32m2623\u001b[39m     cruise = \u001b[43mCruise\u001b[49m\u001b[43m(\u001b[49m\u001b[43mtemp_config_path\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m   2624\u001b[39m \u001b[38;5;28;01mfinally\u001b[39;00m:\n\u001b[32m   2625\u001b[39m     \u001b[38;5;66;03m# Clean up temporary file safely\u001b[39;00m\n\u001b[32m   2626\u001b[39m     \u001b[38;5;28;01mif\u001b[39;00m temp_config_path.exists():\n",
      "\u001b[36mFile \u001b[39m\u001b[32m~/work/cruiseplan/cruiseplan/cruiseplan/core/cruise.py:84\u001b[39m, in \u001b[36mCruise.__init__\u001b[39m\u001b[34m(self, config_path)\u001b[39m\n\u001b[32m     81\u001b[39m \u001b[38;5;28mself\u001b[39m.raw_data = \u001b[38;5;28mself\u001b[39m._load_yaml()\n\u001b[32m     83\u001b[39m \u001b[38;5;66;03m# 1. Validation Pass (Pydantic)\u001b[39;00m\n\u001b[32m---> \u001b[39m\u001b[32m84\u001b[39m \u001b[38;5;28mself\u001b[39m.config = \u001b[43mCruiseConfig\u001b[49m\u001b[43m(\u001b[49m\u001b[43m*\u001b[49m\u001b[43m*\u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mraw_data\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m     86\u001b[39m \u001b[38;5;66;03m# 2. Indexing Pass (Build the Catalog Registry)\u001b[39;00m\n\u001b[32m     87\u001b[39m \u001b[38;5;28mself\u001b[39m.station_registry: Dict[\u001b[38;5;28mstr\u001b[39m, StationDefinition] = {\n\u001b[32m     88\u001b[39m     s.name: s \u001b[38;5;28;01mfor\u001b[39;00m s \u001b[38;5;129;01min\u001b[39;00m (\u001b[38;5;28mself\u001b[39m.config.stations \u001b[38;5;129;01mor\u001b[39;00m [])\n\u001b[32m     89\u001b[39m }\n",
      "\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/cruiseplan/lib/python3.13/site-packages/pydantic/main.py:250\u001b[39m, in \u001b[36mBaseModel.__init__\u001b[39m\u001b[34m(self, **data)\u001b[39m\n\u001b[32m    248\u001b[39m \u001b[38;5;66;03m# `__tracebackhide__` tells pytest and some other tools to omit this function from tracebacks\u001b[39;00m\n\u001b[32m    249\u001b[39m __tracebackhide__ = \u001b[38;5;28;01mTrue\u001b[39;00m\n\u001b[32m--> \u001b[39m\u001b[32m250\u001b[39m validated_self = \u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43m__pydantic_validator__\u001b[49m\u001b[43m.\u001b[49m\u001b[43mvalidate_python\u001b[49m\u001b[43m(\u001b[49m\u001b[43mdata\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mself_instance\u001b[49m\u001b[43m=\u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m)\u001b[49m\n\u001b[32m    251\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m \u001b[38;5;28mself\u001b[39m \u001b[38;5;129;01mis\u001b[39;00m \u001b[38;5;129;01mnot\u001b[39;00m validated_self:\n\u001b[32m    252\u001b[39m     warnings.warn(\n\u001b[32m    253\u001b[39m         \u001b[33m'\u001b[39m\u001b[33mA custom validator is returning a value other than `self`.\u001b[39m\u001b[38;5;130;01m\\n\u001b[39;00m\u001b[33m'\u001b[39m\n\u001b[32m    254\u001b[39m         \u001b[33m\"\u001b[39m\u001b[33mReturning anything other than `self` from a top level model validator isn\u001b[39m\u001b[33m'\u001b[39m\u001b[33mt supported when validating via `__init__`.\u001b[39m\u001b[38;5;130;01m\\n\u001b[39;00m\u001b[33m\"\u001b[39m\n\u001b[32m    255\u001b[39m         \u001b[33m'\u001b[39m\u001b[33mSee the `model_validator` docs (https://docs.pydantic.dev/latest/concepts/validators/#model-validators) for more details.\u001b[39m\u001b[33m'\u001b[39m,\n\u001b[32m    256\u001b[39m         stacklevel=\u001b[32m2\u001b[39m,\n\u001b[32m    257\u001b[39m     )\n",
      "\u001b[31mValidationError\u001b[39m: 12 validation errors for CruiseConfig\ndeparture_port.str\n  Input should be a valid string [type=string_type, input_value={'name': 'St. Johns', 'po... 'longitude': -52.7126}}, input_type=CommentedMap]\n    For further information visit https://errors.pydantic.dev/2.12/v/string_type\ndeparture_port.PortDefinition.latitude\n  Field required [type=missing, input_value={'name': 'St. Johns', 'po... 'longitude': -52.7126}}, input_type=CommentedMap]\n    For further information visit https://errors.pydantic.dev/2.12/v/missing\ndeparture_port.PortDefinition.longitude\n  Field required [type=missing, input_value={'name': 'St. Johns', 'po... 'longitude': -52.7126}}, input_type=CommentedMap]\n    For further information visit https://errors.pydantic.dev/2.12/v/missing\narrival_port.str\n  Input should be a valid string [type=string_type, input_value={'name': 'St. Johns', 'po... 'longitude': -52.7126}}, input_type=CommentedMap]\n    For further information visit https://errors.pydantic.dev/2.12/v/string_type\narrival_port.PortDefinition.latitude\n  Field required [type=missing, input_value={'name': 'St. Johns', 'po... 'longitude': -52.7126}}, input_type=CommentedMap]\n    For further information visit https://errors.pydantic.dev/2.12/v/missing\narrival_port.PortDefinition.longitude\n  Field required [type=missing, input_value={'name': 'St. Johns', 'po... 'longitude': -52.7126}}, input_type=CommentedMap]\n    For further information visit https://errors.pydantic.dev/2.12/v/missing\nlegs.0.departure_port\n  Field required [type=missing, input_value={'name': 'Outbound_Survey...': ['Demo_CTD_Section']}, input_type=CommentedMap]\n    For further information visit https://errors.pydantic.dev/2.12/v/missing\nlegs.0.arrival_port\n  Field required [type=missing, input_value={'name': 'Outbound_Survey...': ['Demo_CTD_Section']}, input_type=CommentedMap]\n    For further information visit https://errors.pydantic.dev/2.12/v/missing\nlegs.1.departure_port\n  Field required [type=missing, input_value={'name': 'Return_Survey',...'sequence': ['STN_006']}, input_type=CommentedMap]\n    For further information visit https://errors.pydantic.dev/2.12/v/missing\nlegs.1.arrival_port\n  Field required [type=missing, input_value={'name': 'Return_Survey',...'sequence': ['STN_006']}, input_type=CommentedMap]\n    For further information visit https://errors.pydantic.dev/2.12/v/missing\nfirst_station\n  Extra inputs are not permitted [type=extra_forbidden, input_value='STN_001', input_type=str]\n    For further information visit https://errors.pydantic.dev/2.12/v/extra_forbidden\nlast_station\n  Extra inputs are not permitted [type=extra_forbidden, input_value='STN_006', input_type=str]\n    For further information visit https://errors.pydantic.dev/2.12/v/extra_forbidden"
     ]
    }
   ],
   "source": [
    "print(\"üîß Enriching configuration...\")\n",
    "\n",
    "config_file = output_dir / \"demo_cruise.yaml\"\n",
    "enriched_config_file = output_dir / \"demo_cruise_enriched.yaml\"\n",
    "\n",
    "# Use the actual enrichment function\n",
    "summary = enrich_configuration(\n",
    "    config_path=config_file,\n",
    "    add_depths=True,\n",
    "    add_coords=True,\n",
    "    expand_sections=True,\n",
    "    bathymetry_source=\"etopo2022\",\n",
    "    coord_format=\"dmm\",\n",
    "    output_path=enriched_config_file\n",
    ")\n",
    "\n",
    "print(f\"‚úÖ Configuration enriched and saved to {enriched_config_file}\")\n",
    "if summary:\n",
    "    if summary.get('sections_expanded', 0) > 0:\n",
    "        print(f\"   - Expanded {summary['sections_expanded']} CTD sections\")\n",
    "        print(f\"   - Created {summary['stations_from_expansion']} new stations\")\n",
    "    if summary.get('stations_with_depths_added', 0) > 0:\n",
    "        print(f\"   - Added depths to {summary['stations_with_depths_added']} stations\")\n",
    "    if summary.get('stations_with_coords_added', 0) > 0:\n",
    "        print(f\"   - Added coordinates to {summary['stations_with_coords_added']} stations\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "step8-header",
   "metadata": {},
   "source": [
    "## Step 7: Generate Maps\n",
    "\n",
    "**CLI Equivalent**: `cruiseplan map -c demo_cruise_enriched.yaml --output-file demo_map.png`\n",
    "\n",
    "Create visualization maps of the cruise plan."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "id": "68ed6cdc",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-12-19T22:24:07.258846Z",
     "iopub.status.busy": "2025-12-19T22:24:07.258629Z",
     "iopub.status.idle": "2025-12-19T22:24:07.263343Z",
     "shell.execute_reply": "2025-12-19T22:24:07.262716Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "üó∫Ô∏è Generating cruise track map with bathymetry...\n",
      "‚ùå Map generation failed: YAML file not found: ../tests_output/demo/demo_cruise_enriched.yaml\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Traceback (most recent call last):\n",
      "  File \"/tmp/ipykernel_2636/1156403205.py\", line 6, in <module>\n",
      "    cruise = Cruise(enriched_config_file)\n",
      "  File \"/home/runner/work/cruiseplan/cruiseplan/cruiseplan/core/cruise.py\", line 81, in __init__\n",
      "    self.raw_data = self._load_yaml()\n",
      "                    ~~~~~~~~~~~~~~~^^\n",
      "  File \"/home/runner/work/cruiseplan/cruiseplan/cruiseplan/core/cruise.py\", line 125, in _load_yaml\n",
      "    return load_yaml(self.config_path)\n",
      "  File \"/home/runner/work/cruiseplan/cruiseplan/cruiseplan/utils/yaml_io.py\", line 69, in load_yaml\n",
      "    raise YAMLIOError(f\"YAML file not found: {file_path}\")\n",
      "cruiseplan.utils.yaml_io.YAMLIOError: YAML file not found: ../tests_output/demo/demo_cruise_enriched.yaml\n"
     ]
    }
   ],
   "source": [
    "print(\"üó∫Ô∏è Generating cruise track map with bathymetry...\")\n",
    "\n",
    "try:\n",
    "    # Load the enriched cruise configuration\n",
    "    enriched_config_file = output_dir / \"demo_cruise_enriched.yaml\"\n",
    "    cruise = Cruise(enriched_config_file)\n",
    "\n",
    "    # Generate the map using the new function\n",
    "    map_file = generate_map_from_yaml(\n",
    "        cruise,\n",
    "        output_file=\"demo_cruise_map.png\",\n",
    "        bathymetry_source=\"gebco2025\",\n",
    "        bathymetry_stride=5,\n",
    "        show_plot=True  # Display inline in notebook\n",
    "    )\n",
    "\n",
    "    if map_file:\n",
    "        print(\"‚úÖ Map generated and displayed\")\n",
    "    else:\n",
    "        print(\"‚ùå Map generation failed\")\n",
    "\n",
    "except Exception as e:\n",
    "    print(f\"‚ùå Map generation failed: {e}\")\n",
    "    import traceback\n",
    "    traceback.print_exc()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "step7-header",
   "metadata": {},
   "source": [
    "## Step 8: Generate Schedule\n",
    "\n",
    "**CLI Equivalent**: `cruiseplan schedule -c demo_cruise_enriched.yaml -o tests_output/demo/ --format all`\n",
    "\n",
    "Generate the complete cruise timeline and output files."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "id": "step7-schedule",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-12-19T22:24:07.265059Z",
     "iopub.status.busy": "2025-12-19T22:24:07.264874Z",
     "iopub.status.idle": "2025-12-19T22:24:07.375893Z",
     "shell.execute_reply": "2025-12-19T22:24:07.375180Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "üìÖ Generating cruise schedule...\n"
     ]
    },
    {
     "ename": "YAMLIOError",
     "evalue": "YAML file not found: ../tests_output/demo/demo_cruise_enriched.yaml",
     "output_type": "error",
     "traceback": [
      "\u001b[31m---------------------------------------------------------------------------\u001b[39m",
      "\u001b[31mYAMLIOError\u001b[39m                               Traceback (most recent call last)",
      "\u001b[36mCell\u001b[39m\u001b[36m \u001b[39m\u001b[32mIn[9]\u001b[39m\u001b[32m, line 4\u001b[39m\n\u001b[32m      1\u001b[39m \u001b[38;5;28mprint\u001b[39m(\u001b[33m\"\u001b[39m\u001b[33müìÖ Generating cruise schedule...\u001b[39m\u001b[33m\"\u001b[39m)\n\u001b[32m      3\u001b[39m \u001b[38;5;66;03m# Generate the schedule with multiple output formats\u001b[39;00m\n\u001b[32m----> \u001b[39m\u001b[32m4\u001b[39m schedule_results = \u001b[43mgenerate_cruise_schedule\u001b[49m\u001b[43m(\u001b[49m\n\u001b[32m      5\u001b[39m \u001b[43m    \u001b[49m\u001b[43mconfig_path\u001b[49m\u001b[43m=\u001b[49m\u001b[43menriched_config_file\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m      6\u001b[39m \u001b[43m    \u001b[49m\u001b[43moutput_dir\u001b[49m\u001b[43m=\u001b[49m\u001b[43moutput_dir\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m      7\u001b[39m \u001b[43m    \u001b[49m\u001b[43mformats\u001b[49m\u001b[43m=\u001b[49m\u001b[43m[\u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43mhtml\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43mcsv\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m,\u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43mnetcdf\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m]\u001b[49m\u001b[43m,\u001b[49m\u001b[43m  \u001b[49m\u001b[38;5;66;43;03m# Available formats: html, csv, latex, netcdf, kml, png\u001b[39;49;00m\n\u001b[32m      8\u001b[39m \u001b[43m    \u001b[49m\u001b[43mvalidate_depths\u001b[49m\u001b[43m=\u001b[49m\u001b[38;5;28;43;01mFalse\u001b[39;49;00m\u001b[43m,\u001b[49m\n\u001b[32m      9\u001b[39m \u001b[43m    \u001b[49m\u001b[43mselected_leg\u001b[49m\u001b[43m=\u001b[49m\u001b[38;5;28;43;01mNone\u001b[39;49;00m\n\u001b[32m     10\u001b[39m \u001b[43m)\u001b[49m\n\u001b[32m     12\u001b[39m \u001b[38;5;28mprint\u001b[39m(\u001b[33m\"\u001b[39m\u001b[33m‚úÖ Schedule generated successfully!\u001b[39m\u001b[33m\"\u001b[39m)\n\u001b[32m     13\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m schedule_results:\n",
      "\u001b[36mFile \u001b[39m\u001b[32m~/work/cruiseplan/cruiseplan/cruiseplan/calculators/scheduler.py:1353\u001b[39m, in \u001b[36mgenerate_cruise_schedule\u001b[39m\u001b[34m(config_path, output_dir, formats, validate_depths, selected_leg, derive_netcdf)\u001b[39m\n\u001b[32m   1350\u001b[39m     formats = [\u001b[33m\"\u001b[39m\u001b[33mhtml\u001b[39m\u001b[33m\"\u001b[39m, \u001b[33m\"\u001b[39m\u001b[33mcsv\u001b[39m\u001b[33m\"\u001b[39m]\n\u001b[32m   1352\u001b[39m \u001b[38;5;66;03m# Load cruise configuration\u001b[39;00m\n\u001b[32m-> \u001b[39m\u001b[32m1353\u001b[39m cruise = \u001b[43mCruise\u001b[49m\u001b[43m(\u001b[49m\u001b[43mconfig_path\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m   1354\u001b[39m config = cruise.config\n\u001b[32m   1356\u001b[39m logger.info(\u001b[33mf\u001b[39m\u001b[33m\"\u001b[39m\u001b[33mLoaded cruise: \u001b[39m\u001b[38;5;132;01m{\u001b[39;00mconfig.cruise_name\u001b[38;5;132;01m}\u001b[39;00m\u001b[33m\"\u001b[39m)\n",
      "\u001b[36mFile \u001b[39m\u001b[32m~/work/cruiseplan/cruiseplan/cruiseplan/core/cruise.py:81\u001b[39m, in \u001b[36mCruise.__init__\u001b[39m\u001b[34m(self, config_path)\u001b[39m\n\u001b[32m     56\u001b[39m \u001b[38;5;250m\u001b[39m\u001b[33;03m\"\"\"\u001b[39;00m\n\u001b[32m     57\u001b[39m \u001b[33;03mInitialize a Cruise object from a YAML configuration file.\u001b[39;00m\n\u001b[32m     58\u001b[39m \n\u001b[32m   (...)\u001b[39m\u001b[32m     78\u001b[39m \u001b[33;03m    If referenced stations or transits are not found in the catalog.\u001b[39;00m\n\u001b[32m     79\u001b[39m \u001b[33;03m\"\"\"\u001b[39;00m\n\u001b[32m     80\u001b[39m \u001b[38;5;28mself\u001b[39m.config_path = Path(config_path)\n\u001b[32m---> \u001b[39m\u001b[32m81\u001b[39m \u001b[38;5;28mself\u001b[39m.raw_data = \u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43m_load_yaml\u001b[49m\u001b[43m(\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m     83\u001b[39m \u001b[38;5;66;03m# 1. Validation Pass (Pydantic)\u001b[39;00m\n\u001b[32m     84\u001b[39m \u001b[38;5;28mself\u001b[39m.config = CruiseConfig(**\u001b[38;5;28mself\u001b[39m.raw_data)\n",
      "\u001b[36mFile \u001b[39m\u001b[32m~/work/cruiseplan/cruiseplan/cruiseplan/core/cruise.py:125\u001b[39m, in \u001b[36mCruise._load_yaml\u001b[39m\u001b[34m(self)\u001b[39m\n\u001b[32m    109\u001b[39m \u001b[38;5;28;01mdef\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34m_load_yaml\u001b[39m(\u001b[38;5;28mself\u001b[39m) -> Dict[\u001b[38;5;28mstr\u001b[39m, Any]:\n\u001b[32m    110\u001b[39m \u001b[38;5;250m    \u001b[39m\u001b[33;03m\"\"\"\u001b[39;00m\n\u001b[32m    111\u001b[39m \u001b[33;03m    Load and parse the YAML configuration file.\u001b[39;00m\n\u001b[32m    112\u001b[39m \n\u001b[32m   (...)\u001b[39m\u001b[32m    123\u001b[39m \u001b[33;03m        If the YAML file cannot be parsed.\u001b[39;00m\n\u001b[32m    124\u001b[39m \u001b[33;03m    \"\"\"\u001b[39;00m\n\u001b[32m--> \u001b[39m\u001b[32m125\u001b[39m     \u001b[38;5;28;01mreturn\u001b[39;00m \u001b[43mload_yaml\u001b[49m\u001b[43m(\u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mconfig_path\u001b[49m\u001b[43m)\u001b[49m\n",
      "\u001b[36mFile \u001b[39m\u001b[32m~/work/cruiseplan/cruiseplan/cruiseplan/utils/yaml_io.py:69\u001b[39m, in \u001b[36mload_yaml\u001b[39m\u001b[34m(file_path, encoding)\u001b[39m\n\u001b[32m     66\u001b[39m file_path = Path(file_path)\n\u001b[32m     68\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m \u001b[38;5;129;01mnot\u001b[39;00m file_path.exists():\n\u001b[32m---> \u001b[39m\u001b[32m69\u001b[39m     \u001b[38;5;28;01mraise\u001b[39;00m YAMLIOError(\u001b[33mf\u001b[39m\u001b[33m\"\u001b[39m\u001b[33mYAML file not found: \u001b[39m\u001b[38;5;132;01m{\u001b[39;00mfile_path\u001b[38;5;132;01m}\u001b[39;00m\u001b[33m\"\u001b[39m)\n\u001b[32m     71\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m \u001b[38;5;129;01mnot\u001b[39;00m file_path.is_file():\n\u001b[32m     72\u001b[39m     \u001b[38;5;28;01mraise\u001b[39;00m YAMLIOError(\u001b[33mf\u001b[39m\u001b[33m\"\u001b[39m\u001b[33mPath is not a file: \u001b[39m\u001b[38;5;132;01m{\u001b[39;00mfile_path\u001b[38;5;132;01m}\u001b[39;00m\u001b[33m\"\u001b[39m)\n",
      "\u001b[31mYAMLIOError\u001b[39m: YAML file not found: ../tests_output/demo/demo_cruise_enriched.yaml"
     ]
    }
   ],
   "source": [
    "print(\"üìÖ Generating cruise schedule...\")\n",
    "\n",
    "# Generate the schedule with multiple output formats\n",
    "schedule_results = generate_cruise_schedule(\n",
    "    config_path=enriched_config_file,\n",
    "    output_dir=output_dir,\n",
    "    formats=[\"html\", \"csv\",\"netcdf\"],  # Available formats: html, csv, latex, netcdf, kml, png\n",
    "    validate_depths=False,\n",
    "    selected_leg=None\n",
    ")\n",
    "\n",
    "print(\"‚úÖ Schedule generated successfully!\")\n",
    "if schedule_results:\n",
    "    for format_type, filepath in schedule_results.items():\n",
    "        print(f\"   - {format_type.upper()}: {filepath}\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "id": "3dc2450d",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-12-19T22:24:07.377510Z",
     "iopub.status.busy": "2025-12-19T22:24:07.377356Z",
     "iopub.status.idle": "2025-12-19T22:24:07.585772Z",
     "shell.execute_reply": "2025-12-19T22:24:07.584957Z"
    }
   },
   "outputs": [
    {
     "ename": "FileNotFoundError",
     "evalue": "[Errno 2] No such file or directory: '/home/runner/work/cruiseplan/cruiseplan/tests_output/demo/Demo_North_Atlantic_Survey_2025_schedule.nc'",
     "output_type": "error",
     "traceback": [
      "\u001b[31m---------------------------------------------------------------------------\u001b[39m",
      "\u001b[31mKeyError\u001b[39m                                  Traceback (most recent call last)",
      "\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/cruiseplan/lib/python3.13/site-packages/xarray/backends/file_manager.py:219\u001b[39m, in \u001b[36mCachingFileManager._acquire_with_cache_info\u001b[39m\u001b[34m(self, needs_lock)\u001b[39m\n\u001b[32m    218\u001b[39m \u001b[38;5;28;01mtry\u001b[39;00m:\n\u001b[32m--> \u001b[39m\u001b[32m219\u001b[39m     file = \u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43m_cache\u001b[49m\u001b[43m[\u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43m_key\u001b[49m\u001b[43m]\u001b[49m\n\u001b[32m    220\u001b[39m \u001b[38;5;28;01mexcept\u001b[39;00m \u001b[38;5;167;01mKeyError\u001b[39;00m:\n",
      "\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/cruiseplan/lib/python3.13/site-packages/xarray/backends/lru_cache.py:56\u001b[39m, in \u001b[36mLRUCache.__getitem__\u001b[39m\u001b[34m(self, key)\u001b[39m\n\u001b[32m     55\u001b[39m \u001b[38;5;28;01mwith\u001b[39;00m \u001b[38;5;28mself\u001b[39m._lock:\n\u001b[32m---> \u001b[39m\u001b[32m56\u001b[39m     value = \u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43m_cache\u001b[49m\u001b[43m[\u001b[49m\u001b[43mkey\u001b[49m\u001b[43m]\u001b[49m\n\u001b[32m     57\u001b[39m     \u001b[38;5;28mself\u001b[39m._cache.move_to_end(key)\n",
      "\u001b[31mKeyError\u001b[39m: [<class 'netCDF4._netCDF4.Dataset'>, ('/home/runner/work/cruiseplan/cruiseplan/tests_output/demo/Demo_North_Atlantic_Survey_2025_schedule.nc',), 'r', (('clobber', True), ('diskless', False), ('format', 'NETCDF4'), ('persist', False)), '4d4b6d1c-4382-469f-8959-54a17e2df5e5']",
      "\nDuring handling of the above exception, another exception occurred:\n",
      "\u001b[31mFileNotFoundError\u001b[39m                         Traceback (most recent call last)",
      "\u001b[36mCell\u001b[39m\u001b[36m \u001b[39m\u001b[32mIn[10]\u001b[39m\u001b[32m, line 1\u001b[39m\n\u001b[32m----> \u001b[39m\u001b[32m1\u001b[39m ds = \u001b[43mxr\u001b[49m\u001b[43m.\u001b[49m\u001b[43mopen_dataset\u001b[49m\u001b[43m(\u001b[49m\u001b[43moutput_dir\u001b[49m\u001b[43m \u001b[49m\u001b[43m/\u001b[49m\u001b[43m \u001b[49m\u001b[33;43m'\u001b[39;49m\u001b[33;43mDemo_North_Atlantic_Survey_2025_schedule.nc\u001b[39;49m\u001b[33;43m'\u001b[39;49m\u001b[43m)\u001b[49m\n\u001b[32m      2\u001b[39m ds\n",
      "\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/cruiseplan/lib/python3.13/site-packages/xarray/backends/api.py:606\u001b[39m, in \u001b[36mopen_dataset\u001b[39m\u001b[34m(filename_or_obj, engine, chunks, cache, decode_cf, mask_and_scale, decode_times, decode_timedelta, use_cftime, concat_characters, decode_coords, drop_variables, create_default_indexes, inline_array, chunked_array_type, from_array_kwargs, backend_kwargs, **kwargs)\u001b[39m\n\u001b[32m    594\u001b[39m decoders = _resolve_decoders_kwargs(\n\u001b[32m    595\u001b[39m     decode_cf,\n\u001b[32m    596\u001b[39m     open_backend_dataset_parameters=backend.open_dataset_parameters,\n\u001b[32m   (...)\u001b[39m\u001b[32m    602\u001b[39m     decode_coords=decode_coords,\n\u001b[32m    603\u001b[39m )\n\u001b[32m    605\u001b[39m overwrite_encoded_chunks = kwargs.pop(\u001b[33m\"\u001b[39m\u001b[33moverwrite_encoded_chunks\u001b[39m\u001b[33m\"\u001b[39m, \u001b[38;5;28;01mNone\u001b[39;00m)\n\u001b[32m--> \u001b[39m\u001b[32m606\u001b[39m backend_ds = \u001b[43mbackend\u001b[49m\u001b[43m.\u001b[49m\u001b[43mopen_dataset\u001b[49m\u001b[43m(\u001b[49m\n\u001b[32m    607\u001b[39m \u001b[43m    \u001b[49m\u001b[43mfilename_or_obj\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    608\u001b[39m \u001b[43m    \u001b[49m\u001b[43mdrop_variables\u001b[49m\u001b[43m=\u001b[49m\u001b[43mdrop_variables\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    609\u001b[39m \u001b[43m    \u001b[49m\u001b[43m*\u001b[49m\u001b[43m*\u001b[49m\u001b[43mdecoders\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    610\u001b[39m \u001b[43m    \u001b[49m\u001b[43m*\u001b[49m\u001b[43m*\u001b[49m\u001b[43mkwargs\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    611\u001b[39m \u001b[43m\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    612\u001b[39m ds = _dataset_from_backend_dataset(\n\u001b[32m    613\u001b[39m     backend_ds,\n\u001b[32m    614\u001b[39m     filename_or_obj,\n\u001b[32m   (...)\u001b[39m\u001b[32m    625\u001b[39m     **kwargs,\n\u001b[32m    626\u001b[39m )\n\u001b[32m    627\u001b[39m \u001b[38;5;28;01mreturn\u001b[39;00m ds\n",
      "\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/cruiseplan/lib/python3.13/site-packages/xarray/backends/netCDF4_.py:767\u001b[39m, in \u001b[36mNetCDF4BackendEntrypoint.open_dataset\u001b[39m\u001b[34m(self, filename_or_obj, mask_and_scale, decode_times, concat_characters, decode_coords, drop_variables, use_cftime, decode_timedelta, group, mode, format, clobber, diskless, persist, auto_complex, lock, autoclose)\u001b[39m\n\u001b[32m    745\u001b[39m \u001b[38;5;28;01mdef\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34mopen_dataset\u001b[39m(\n\u001b[32m    746\u001b[39m     \u001b[38;5;28mself\u001b[39m,\n\u001b[32m    747\u001b[39m     filename_or_obj: T_PathFileOrDataStore,\n\u001b[32m   (...)\u001b[39m\u001b[32m    764\u001b[39m     autoclose=\u001b[38;5;28;01mFalse\u001b[39;00m,\n\u001b[32m    765\u001b[39m ) -> Dataset:\n\u001b[32m    766\u001b[39m     filename_or_obj = _normalize_path(filename_or_obj)\n\u001b[32m--> \u001b[39m\u001b[32m767\u001b[39m     store = \u001b[43mNetCDF4DataStore\u001b[49m\u001b[43m.\u001b[49m\u001b[43mopen\u001b[49m\u001b[43m(\u001b[49m\n\u001b[32m    768\u001b[39m \u001b[43m        \u001b[49m\u001b[43mfilename_or_obj\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    769\u001b[39m \u001b[43m        \u001b[49m\u001b[43mmode\u001b[49m\u001b[43m=\u001b[49m\u001b[43mmode\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    770\u001b[39m \u001b[43m        \u001b[49m\u001b[38;5;28;43mformat\u001b[39;49m\u001b[43m=\u001b[49m\u001b[38;5;28;43mformat\u001b[39;49m\u001b[43m,\u001b[49m\n\u001b[32m    771\u001b[39m \u001b[43m        \u001b[49m\u001b[43mgroup\u001b[49m\u001b[43m=\u001b[49m\u001b[43mgroup\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    772\u001b[39m \u001b[43m        \u001b[49m\u001b[43mclobber\u001b[49m\u001b[43m=\u001b[49m\u001b[43mclobber\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    773\u001b[39m \u001b[43m        \u001b[49m\u001b[43mdiskless\u001b[49m\u001b[43m=\u001b[49m\u001b[43mdiskless\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    774\u001b[39m \u001b[43m        \u001b[49m\u001b[43mpersist\u001b[49m\u001b[43m=\u001b[49m\u001b[43mpersist\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    775\u001b[39m \u001b[43m        \u001b[49m\u001b[43mauto_complex\u001b[49m\u001b[43m=\u001b[49m\u001b[43mauto_complex\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    776\u001b[39m \u001b[43m        \u001b[49m\u001b[43mlock\u001b[49m\u001b[43m=\u001b[49m\u001b[43mlock\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    777\u001b[39m \u001b[43m        \u001b[49m\u001b[43mautoclose\u001b[49m\u001b[43m=\u001b[49m\u001b[43mautoclose\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    778\u001b[39m \u001b[43m    \u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    780\u001b[39m     store_entrypoint = StoreBackendEntrypoint()\n\u001b[32m    781\u001b[39m     \u001b[38;5;28;01mwith\u001b[39;00m close_on_error(store):\n",
      "\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/cruiseplan/lib/python3.13/site-packages/xarray/backends/netCDF4_.py:525\u001b[39m, in \u001b[36mNetCDF4DataStore.open\u001b[39m\u001b[34m(cls, filename, mode, format, group, clobber, diskless, persist, auto_complex, lock, lock_maker, autoclose)\u001b[39m\n\u001b[32m    521\u001b[39m \u001b[38;5;28;01melse\u001b[39;00m:\n\u001b[32m    522\u001b[39m     manager = CachingFileManager(\n\u001b[32m    523\u001b[39m         netCDF4.Dataset, filename, mode=mode, kwargs=kwargs\n\u001b[32m    524\u001b[39m     )\n\u001b[32m--> \u001b[39m\u001b[32m525\u001b[39m \u001b[38;5;28;01mreturn\u001b[39;00m \u001b[38;5;28;43mcls\u001b[39;49m\u001b[43m(\u001b[49m\u001b[43mmanager\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mgroup\u001b[49m\u001b[43m=\u001b[49m\u001b[43mgroup\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mmode\u001b[49m\u001b[43m=\u001b[49m\u001b[43mmode\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mlock\u001b[49m\u001b[43m=\u001b[49m\u001b[43mlock\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mautoclose\u001b[49m\u001b[43m=\u001b[49m\u001b[43mautoclose\u001b[49m\u001b[43m)\u001b[49m\n",
      "\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/cruiseplan/lib/python3.13/site-packages/xarray/backends/netCDF4_.py:429\u001b[39m, in \u001b[36mNetCDF4DataStore.__init__\u001b[39m\u001b[34m(self, manager, group, mode, lock, autoclose)\u001b[39m\n\u001b[32m    427\u001b[39m \u001b[38;5;28mself\u001b[39m._group = group\n\u001b[32m    428\u001b[39m \u001b[38;5;28mself\u001b[39m._mode = mode\n\u001b[32m--> \u001b[39m\u001b[32m429\u001b[39m \u001b[38;5;28mself\u001b[39m.format = \u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mds\u001b[49m.data_model\n\u001b[32m    430\u001b[39m \u001b[38;5;28mself\u001b[39m._filename = \u001b[38;5;28mself\u001b[39m.ds.filepath()\n\u001b[32m    431\u001b[39m \u001b[38;5;28mself\u001b[39m.is_remote = is_remote_uri(\u001b[38;5;28mself\u001b[39m._filename)\n",
      "\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/cruiseplan/lib/python3.13/site-packages/xarray/backends/netCDF4_.py:534\u001b[39m, in \u001b[36mNetCDF4DataStore.ds\u001b[39m\u001b[34m(self)\u001b[39m\n\u001b[32m    532\u001b[39m \u001b[38;5;129m@property\u001b[39m\n\u001b[32m    533\u001b[39m \u001b[38;5;28;01mdef\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34mds\u001b[39m(\u001b[38;5;28mself\u001b[39m):\n\u001b[32m--> \u001b[39m\u001b[32m534\u001b[39m     \u001b[38;5;28;01mreturn\u001b[39;00m \u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43m_acquire\u001b[49m\u001b[43m(\u001b[49m\u001b[43m)\u001b[49m\n",
      "\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/cruiseplan/lib/python3.13/site-packages/xarray/backends/netCDF4_.py:528\u001b[39m, in \u001b[36mNetCDF4DataStore._acquire\u001b[39m\u001b[34m(self, needs_lock)\u001b[39m\n\u001b[32m    527\u001b[39m \u001b[38;5;28;01mdef\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34m_acquire\u001b[39m(\u001b[38;5;28mself\u001b[39m, needs_lock=\u001b[38;5;28;01mTrue\u001b[39;00m):\n\u001b[32m--> \u001b[39m\u001b[32m528\u001b[39m \u001b[43m    \u001b[49m\u001b[38;5;28;43;01mwith\u001b[39;49;00m\u001b[43m \u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43m_manager\u001b[49m\u001b[43m.\u001b[49m\u001b[43macquire_context\u001b[49m\u001b[43m(\u001b[49m\u001b[43mneeds_lock\u001b[49m\u001b[43m)\u001b[49m\u001b[43m \u001b[49m\u001b[38;5;28;43;01mas\u001b[39;49;00m\u001b[43m \u001b[49m\u001b[43mroot\u001b[49m\u001b[43m:\u001b[49m\n\u001b[32m    529\u001b[39m \u001b[43m        \u001b[49m\u001b[43mds\u001b[49m\u001b[43m \u001b[49m\u001b[43m=\u001b[49m\u001b[43m \u001b[49m\u001b[43m_nc4_require_group\u001b[49m\u001b[43m(\u001b[49m\u001b[43mroot\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43m_group\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43m_mode\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    530\u001b[39m     \u001b[38;5;28;01mreturn\u001b[39;00m ds\n",
      "\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/cruiseplan/lib/python3.13/contextlib.py:141\u001b[39m, in \u001b[36m_GeneratorContextManager.__enter__\u001b[39m\u001b[34m(self)\u001b[39m\n\u001b[32m    139\u001b[39m \u001b[38;5;28;01mdel\u001b[39;00m \u001b[38;5;28mself\u001b[39m.args, \u001b[38;5;28mself\u001b[39m.kwds, \u001b[38;5;28mself\u001b[39m.func\n\u001b[32m    140\u001b[39m \u001b[38;5;28;01mtry\u001b[39;00m:\n\u001b[32m--> \u001b[39m\u001b[32m141\u001b[39m     \u001b[38;5;28;01mreturn\u001b[39;00m \u001b[38;5;28;43mnext\u001b[39;49m\u001b[43m(\u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mgen\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    142\u001b[39m \u001b[38;5;28;01mexcept\u001b[39;00m \u001b[38;5;167;01mStopIteration\u001b[39;00m:\n\u001b[32m    143\u001b[39m     \u001b[38;5;28;01mraise\u001b[39;00m \u001b[38;5;167;01mRuntimeError\u001b[39;00m(\u001b[33m\"\u001b[39m\u001b[33mgenerator didn\u001b[39m\u001b[33m'\u001b[39m\u001b[33mt yield\u001b[39m\u001b[33m\"\u001b[39m) \u001b[38;5;28;01mfrom\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[38;5;28;01mNone\u001b[39;00m\n",
      "\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/cruiseplan/lib/python3.13/site-packages/xarray/backends/file_manager.py:207\u001b[39m, in \u001b[36mCachingFileManager.acquire_context\u001b[39m\u001b[34m(self, needs_lock)\u001b[39m\n\u001b[32m    204\u001b[39m \u001b[38;5;129m@contextmanager\u001b[39m\n\u001b[32m    205\u001b[39m \u001b[38;5;28;01mdef\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34macquire_context\u001b[39m(\u001b[38;5;28mself\u001b[39m, needs_lock: \u001b[38;5;28mbool\u001b[39m = \u001b[38;5;28;01mTrue\u001b[39;00m) -> Iterator[T_File]:\n\u001b[32m    206\u001b[39m \u001b[38;5;250m    \u001b[39m\u001b[33;03m\"\"\"Context manager for acquiring a file.\"\"\"\u001b[39;00m\n\u001b[32m--> \u001b[39m\u001b[32m207\u001b[39m     file, cached = \u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43m_acquire_with_cache_info\u001b[49m\u001b[43m(\u001b[49m\u001b[43mneeds_lock\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    208\u001b[39m     \u001b[38;5;28;01mtry\u001b[39;00m:\n\u001b[32m    209\u001b[39m         \u001b[38;5;28;01myield\u001b[39;00m file\n",
      "\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/cruiseplan/lib/python3.13/site-packages/xarray/backends/file_manager.py:225\u001b[39m, in \u001b[36mCachingFileManager._acquire_with_cache_info\u001b[39m\u001b[34m(self, needs_lock)\u001b[39m\n\u001b[32m    223\u001b[39m     kwargs = kwargs.copy()\n\u001b[32m    224\u001b[39m     kwargs[\u001b[33m\"\u001b[39m\u001b[33mmode\u001b[39m\u001b[33m\"\u001b[39m] = \u001b[38;5;28mself\u001b[39m._mode\n\u001b[32m--> \u001b[39m\u001b[32m225\u001b[39m file = \u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43m_opener\u001b[49m\u001b[43m(\u001b[49m\u001b[43m*\u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43m_args\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43m*\u001b[49m\u001b[43m*\u001b[49m\u001b[43mkwargs\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    226\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m \u001b[38;5;28mself\u001b[39m._mode == \u001b[33m\"\u001b[39m\u001b[33mw\u001b[39m\u001b[33m\"\u001b[39m:\n\u001b[32m    227\u001b[39m     \u001b[38;5;66;03m# ensure file doesn't get overridden when opened again\u001b[39;00m\n\u001b[32m    228\u001b[39m     \u001b[38;5;28mself\u001b[39m._mode = \u001b[33m\"\u001b[39m\u001b[33ma\u001b[39m\u001b[33m\"\u001b[39m\n",
      "\u001b[36mFile \u001b[39m\u001b[32msrc/netCDF4/_netCDF4.pyx:2517\u001b[39m, in \u001b[36mnetCDF4._netCDF4.Dataset.__init__\u001b[39m\u001b[34m()\u001b[39m\n",
      "\u001b[36mFile \u001b[39m\u001b[32msrc/netCDF4/_netCDF4.pyx:2154\u001b[39m, in \u001b[36mnetCDF4._netCDF4._ensure_nc_success\u001b[39m\u001b[34m()\u001b[39m\n",
      "\u001b[31mFileNotFoundError\u001b[39m: [Errno 2] No such file or directory: '/home/runner/work/cruiseplan/cruiseplan/tests_output/demo/Demo_North_Atlantic_Survey_2025_schedule.nc'"
     ]
    }
   ],
   "source": [
    "ds = xr.open_dataset(output_dir / 'Demo_North_Atlantic_Survey_2025_schedule.nc')\n",
    "ds"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "summary-header",
   "metadata": {},
   "source": [
    "## Workflow Summary\n",
    "\n",
    "Let's review what we've accomplished and check our output files."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "id": "summary",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-12-19T22:24:07.587566Z",
     "iopub.status.busy": "2025-12-19T22:24:07.587411Z",
     "iopub.status.idle": "2025-12-19T22:24:07.592972Z",
     "shell.execute_reply": "2025-12-19T22:24:07.592346Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "üìã CruisePlan Demo Workflow Complete!\n",
      "\n",
      "üóÇÔ∏è  Generated files in tests_output/demo/:\n",
      "   üìÑ ctd_pangaea_data.pkl           (0.5KB)\n",
      "   üìÑ demo_cruise.yaml               (2.3KB)\n",
      "   üìÑ demo_dois.txt                  (0.1KB)\n",
      "\n",
      "üíæ Total output size: 2.9KB\n",
      "üìÅ Output directory: /home/runner/work/cruiseplan/cruiseplan/notebooks/../tests_output/demo\n",
      "\n",
      "‚ú® Workflow Steps Completed:\n",
      "   1. ‚úÖ Downloaded bathymetry data (ETOPO2022)\n",
      "   2. ‚úÖ Searched PANGAEA database for relevant datasets\n",
      "   3. ‚úÖ Processed DOI list into campaign data\n",
      "   4. ‚úÖ Created station configuration programmatically\n",
      "   5. ‚úÖ Validated configuration and checked depths\n",
      "   6. ‚úÖ Enriched configuration with computed data\n",
      "   7. ‚úÖ Generated complete cruise schedule and timeline\n",
      "   8. ‚úÖ Created interactive cruise track map\n",
      "\n",
      "üéØ Next Steps:\n",
      "   ‚Ä¢ Review demo_cruise_schedule.html for the complete cruise timeline\n",
      "   ‚Ä¢ Examine demo_cruise_enriched.yaml to see the enriched configuration\n",
      "   ‚Ä¢ Import demo_cruise_schedule.nc into data analysis tools\n",
      "\n",
      "üöÄ This demonstrates the complete CruisePlan workflow using Python functions!\n",
      "   Each step corresponds to a CLI command but uses the underlying Python API.\n"
     ]
    }
   ],
   "source": [
    "print(\"üìã CruisePlan Demo Workflow Complete!\")\n",
    "print(\"\\nüóÇÔ∏è  Generated files in tests_output/demo/:\")\n",
    "\n",
    "# List all files in output directory using pathlib.Path\n",
    "\n",
    "output_dir = Path(output_dir)  # Ensure output_dir is a Path object\n",
    "if output_dir.exists():\n",
    "    files = sorted(output_dir.glob('*'))\n",
    "    total_size = 0\n",
    "\n",
    "    for file_path in files:\n",
    "        if file_path.is_file():\n",
    "            size = file_path.stat().st_size\n",
    "            total_size += size\n",
    "            size_str = f\"{size/1024:.1f}KB\" if size < 1024*1024 else f\"{size/1024/1024:.1f}MB\"\n",
    "            print(f\"   üìÑ {file_path.name:<30} ({size_str})\")\n",
    "\n",
    "    print(f\"\\nüíæ Total output size: {total_size/1024:.1f}KB\")\n",
    "    print(f\"üìÅ Output directory: {output_dir.absolute()}\")\n",
    "else:\n",
    "    print(\"   No output files found\")\n",
    "\n",
    "print(\"\\n‚ú® Workflow Steps Completed:\")\n",
    "steps = [\n",
    "    \"1. ‚úÖ Downloaded bathymetry data (ETOPO2022)\",\n",
    "    \"2. ‚úÖ Searched PANGAEA database for relevant datasets\",\n",
    "    \"3. ‚úÖ Processed DOI list into campaign data\",\n",
    "    \"4. ‚úÖ Created station configuration programmatically\",\n",
    "    \"5. ‚úÖ Validated configuration and checked depths\",\n",
    "    \"6. ‚úÖ Enriched configuration with computed data\",\n",
    "    \"7. ‚úÖ Generated complete cruise schedule and timeline\",\n",
    "    \"8. ‚úÖ Created interactive cruise track map\"\n",
    "]\n",
    "\n",
    "for step in steps:\n",
    "    print(f\"   {step}\")\n",
    "\n",
    "print(\"\\nüéØ Next Steps:\")\n",
    "print(\"   ‚Ä¢ Review demo_cruise_schedule.html for the complete cruise timeline\")\n",
    "print(\"   ‚Ä¢ Examine demo_cruise_enriched.yaml to see the enriched configuration\")\n",
    "print(\"   ‚Ä¢ Import demo_cruise_schedule.nc into data analysis tools\")\n",
    "\n",
    "print(\"\\nüöÄ This demonstrates the complete CruisePlan workflow using Python functions!\")\n",
    "print(\"   Each step corresponds to a CLI command but uses the underlying Python API.\")"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": ".venv (3.11.7)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.13.11"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
