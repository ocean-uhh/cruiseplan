

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>cruiseplan.calculators.scheduler &mdash; CruisePlan v0.2.2 v0.2.2.post1.dev5</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css?v=393fce2e" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=526b2a46"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            CruisePlan v0.2.2
              <img src="../../../_static/cruise_plan_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage.html">Usage Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">CLI Workflows</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../user_workflows.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_workflows.html#workflow-paths">Workflow Paths</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_workflows.html#advanced-topics">Advanced Topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_workflows.html#troubleshooting">Troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Notebook Demo</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../demo-output.html">CruisePlan Demo</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Project Specifications</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../cruise_architecture.html">Cruise Specifications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cli_reference.html">CLI Command Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../yaml_reference.html">YAML Configuration Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../operation_types.html">Operation Types Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../calculations.html">Calculation Methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../units_and_defaults.html">Units and defaults</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../global_ports.html">Port list</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../output_formats.html">Output formats</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Help and Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/ocean-uhh/cruiseplan">GitHub Repository</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/modules.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/ocean-uhh/cruiseplan/blob/main/CONTRIBUTING.md">Contributing Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../project_structure.html">Project Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer_guide.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../roadmap.html">Development Roadmap</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">CruisePlan v0.2.2</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">cruiseplan.calculators.scheduler</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for cruiseplan.calculators.scheduler</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Core cruise scheduling and timeline generation logic.</span>

<span class="sd">This module implements sequential ordering logic and time/distance calculation</span>
<span class="sd">for generating complete cruise timelines. Provides the ActivityRecord data structure</span>
<span class="sd">and scheduling algorithms that transform cruise configurations into executable plans.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">cruiseplan.calculators.distance</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">haversine_distance</span><span class="p">,</span>  <span class="c1"># Returns km</span>
    <span class="n">km_to_nm</span><span class="p">,</span>
    <span class="n">route_distance</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cruiseplan.calculators.duration</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">DurationCalculator</span><span class="p">,</span>  <span class="c1"># Provides duration lookup</span>
<span class="p">)</span>

<span class="c1"># Import core components and calculators (assuming they are complete)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cruiseplan.core.validation</span><span class="w"> </span><span class="kn">import</span> <span class="n">CruiseConfig</span><span class="p">,</span> <span class="n">GeoPoint</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cruiseplan.utils.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">hours_to_minutes</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># --- Helper Functions ---</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_extract_coordinates</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GeoPoint</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract coordinates as a GeoPoint from an object.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    obj : Any</span>
<span class="sd">        Object with latitude and longitude attributes.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    GeoPoint</span>
<span class="sd">        Geographic point with latitude and longitude.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">GeoPoint</span><span class="p">(</span><span class="n">latitude</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">longitude</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_activity_position</span><span class="p">(</span><span class="n">activity</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GeoPoint</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the primary position of an activity record.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    activity : dict</span>
<span class="sd">        Activity record dictionary.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    GeoPoint</span>
<span class="sd">        Geographic point with latitude and longitude.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">GeoPoint</span><span class="p">(</span><span class="n">latitude</span><span class="o">=</span><span class="n">activity</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span> <span class="n">longitude</span><span class="o">=</span><span class="n">activity</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">])</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_activity_entry_position</span><span class="p">(</span><span class="n">activity</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GeoPoint</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the entry position of an activity record.</span>

<span class="sd">    For transits with start coordinates, returns the start position.</span>
<span class="sd">    Otherwise returns the main position.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    activity : dict</span>
<span class="sd">        Activity record dictionary.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    GeoPoint</span>
<span class="sd">        Geographic point with latitude and longitude.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">activity</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;op_type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;transit&quot;</span> <span class="ow">and</span> <span class="s2">&quot;start_lat&quot;</span> <span class="ow">in</span> <span class="n">activity</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">GeoPoint</span><span class="p">(</span><span class="n">latitude</span><span class="o">=</span><span class="n">activity</span><span class="p">[</span><span class="s2">&quot;start_lat&quot;</span><span class="p">],</span> <span class="n">longitude</span><span class="o">=</span><span class="n">activity</span><span class="p">[</span><span class="s2">&quot;start_lon&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">_get_activity_position</span><span class="p">(</span><span class="n">activity</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_activity_exit_position</span><span class="p">(</span><span class="n">activity</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GeoPoint</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the exit position of an activity record.</span>

<span class="sd">    For transits with end coordinates, returns the end position.</span>
<span class="sd">    Otherwise returns the main position.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    activity : dict</span>
<span class="sd">        Activity record dictionary.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    GeoPoint</span>
<span class="sd">        Geographic point with latitude and longitude.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">activity</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;op_type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;transit&quot;</span> <span class="ow">and</span> <span class="s2">&quot;end_lat&quot;</span> <span class="ow">in</span> <span class="n">activity</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">GeoPoint</span><span class="p">(</span><span class="n">latitude</span><span class="o">=</span><span class="n">activity</span><span class="p">[</span><span class="s2">&quot;end_lat&quot;</span><span class="p">],</span> <span class="n">longitude</span><span class="o">=</span><span class="n">activity</span><span class="p">[</span><span class="s2">&quot;end_lon&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">_get_activity_position</span><span class="p">(</span><span class="n">activity</span><span class="p">)</span>


<span class="c1"># --- Data Structure Definitions ---</span>


<div class="viewcode-block" id="ActivityRecord">
<a class="viewcode-back" href="../../../api/cruiseplan.calculators.html#cruiseplan.calculators.scheduler.ActivityRecord">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ActivityRecord</span><span class="p">(</span><span class="n">Dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Standardized output structure for a single scheduled activity.</span>

<span class="sd">    This class represents a scheduled cruise activity with all relevant</span>
<span class="sd">    timing, positioning, and operational information.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    activity : str</span>
<span class="sd">        Type of activity (e.g., &quot;Station&quot;, &quot;Transit&quot;, &quot;Mooring&quot;).</span>
<span class="sd">    label : str</span>
<span class="sd">        Human-readable label for the activity.</span>
<span class="sd">    lat : float</span>
<span class="sd">        Latitude in decimal degrees.</span>
<span class="sd">    lon : float</span>
<span class="sd">        Longitude in decimal degrees.</span>
<span class="sd">    depth : float</span>
<span class="sd">        Water depth in meters.</span>
<span class="sd">    start_time : datetime</span>
<span class="sd">        Activity start time.</span>
<span class="sd">    end_time : datetime</span>
<span class="sd">        Activity end time.</span>
<span class="sd">    duration_minutes : float</span>
<span class="sd">        Activity duration in minutes.</span>
<span class="sd">    transit_dist_nm : float</span>
<span class="sd">        Distance traveled to reach this activity in nautical miles.</span>
<span class="sd">    operation_dist_nm : float</span>
<span class="sd">        Distance traveled during this activity in nautical miles.</span>
<span class="sd">    vessel_speed_kt : float</span>
<span class="sd">        Vessel speed in knots.</span>
<span class="sd">    leg_name : str</span>
<span class="sd">        Name of the cruise leg.</span>
<span class="sd">    operation_type : str</span>
<span class="sd">        Type of scientific operation.</span>
<span class="sd">    &quot;&quot;&quot;</span></div>



<span class="c1"># --- Entry/Exit Point Abstraction Helpers ---</span>


<div class="viewcode-block" id="get_operation_entry_exit_points">
<a class="viewcode-back" href="../../../api/cruiseplan.calculators.html#cruiseplan.calculators.scheduler.get_operation_entry_exit_points">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_operation_entry_exit_points</span><span class="p">(</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">CruiseConfig</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get entry and exit points for an operation using the new abstraction methods.</span>

<span class="sd">    This demonstrates the new architecture where routing calculations use</span>
<span class="sd">    standardized entry/exit point methods regardless of operation type.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple[tuple[float, float], tuple[float, float]] or None</span>
<span class="sd">        ((entry_lat, entry_lon), (exit_lat, exit_lon)) or None if not found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Try to create operation objects and use their entry/exit methods</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Check stations (point operations)</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">stations</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">stations</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">cruiseplan.core.operations</span><span class="w"> </span><span class="kn">import</span> <span class="n">PointOperation</span>

                <span class="n">operation</span> <span class="o">=</span> <span class="n">PointOperation</span><span class="o">.</span><span class="n">from_pydantic</span><span class="p">(</span><span class="n">match</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">operation</span><span class="o">.</span><span class="n">get_entry_point</span><span class="p">(),</span> <span class="n">operation</span><span class="o">.</span><span class="n">get_exit_point</span><span class="p">())</span>

        <span class="c1"># Check transits (line operations)</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">transits</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">transits</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">cruiseplan.core.operations</span><span class="w"> </span><span class="kn">import</span> <span class="n">LineOperation</span>

                <span class="n">default_speed</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">default_vessel_speed</span>
                <span class="n">operation</span> <span class="o">=</span> <span class="n">LineOperation</span><span class="o">.</span><span class="n">from_pydantic</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="n">default_speed</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">operation</span><span class="o">.</span><span class="n">get_entry_point</span><span class="p">(),</span> <span class="n">operation</span><span class="o">.</span><span class="n">get_exit_point</span><span class="p">())</span>

        <span class="c1"># Check areas (area operations)</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">areas</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">areas</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">cruiseplan.core.operations</span><span class="w"> </span><span class="kn">import</span> <span class="n">AreaOperation</span>

                <span class="n">operation</span> <span class="o">=</span> <span class="n">AreaOperation</span><span class="o">.</span><span class="n">from_pydantic</span><span class="p">(</span><span class="n">match</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">operation</span><span class="o">.</span><span class="n">get_entry_point</span><span class="p">(),</span> <span class="n">operation</span><span class="o">.</span><span class="n">get_exit_point</span><span class="p">())</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not get entry/exit points for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="get_cluster_entry_exit_points">
<a class="viewcode-back" href="../../../api/cruiseplan.calculators.html#cruiseplan.calculators.scheduler.get_cluster_entry_exit_points">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_cluster_entry_exit_points</span><span class="p">(</span>
    <span class="n">cluster</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">CruiseConfig</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get entry and exit points for a cluster using the new abstraction methods.</span>

<span class="sd">    For clusters, entry point is the first operation&#39;s entry point,</span>
<span class="sd">    and exit point is the last operation&#39;s exit point.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple[tuple[float, float], tuple[float, float]] or None</span>
<span class="sd">        ((entry_lat, entry_lon), (exit_lat, exit_lon)) or None if cluster is empty</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="s2">&quot;get_entry_point&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="s2">&quot;get_exit_point&quot;</span><span class="p">):</span>
        <span class="c1"># Use the cluster&#39;s built-in methods if available</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">entry_point</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">get_entry_point</span><span class="p">()</span>
            <span class="n">exit_point</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">get_exit_point</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">entry_point</span> <span class="ow">and</span> <span class="n">exit_point</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">entry_point</span><span class="p">,</span> <span class="n">exit_point</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not get cluster entry/exit points: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Fallback: get entry/exit from first/last operations in cluster</span>
    <span class="n">operations</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="s2">&quot;operations&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">operations</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">first_op</span> <span class="o">=</span> <span class="n">operations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">last_op</span> <span class="o">=</span> <span class="n">operations</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">first_entry</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">first_op</span><span class="o">.</span><span class="n">get_entry_point</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">first_op</span><span class="p">,</span> <span class="s2">&quot;get_entry_point&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="n">last_exit</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">last_op</span><span class="o">.</span><span class="n">get_exit_point</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">last_op</span><span class="p">,</span> <span class="s2">&quot;get_exit_point&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">first_entry</span> <span class="ow">and</span> <span class="n">last_exit</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">first_entry</span><span class="p">,</span> <span class="n">last_exit</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not get cluster operation entry/exit points: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="calculate_transit_distance_using_abstraction">
<a class="viewcode-back" href="../../../api/cruiseplan.calculators.html#cruiseplan.calculators.scheduler.calculate_transit_distance_using_abstraction">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_transit_distance_using_abstraction</span><span class="p">(</span>
    <span class="n">last_operation_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">current_operation_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">CruiseConfig</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate transit distance between operations using entry/exit point abstraction.</span>

<span class="sd">    This demonstrates how the new abstraction makes routing calculations cleaner:</span>
<span class="sd">    distance = last_operation.get_exit_point() → current_operation.get_entry_point()</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Transit distance in nautical miles</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">last_operation_name</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">current_operation_name</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>

    <span class="c1"># Get exit point of last operation and entry point of current operation</span>
    <span class="n">last_points</span> <span class="o">=</span> <span class="n">get_operation_entry_exit_points</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">last_operation_name</span><span class="p">)</span>
    <span class="n">current_points</span> <span class="o">=</span> <span class="n">get_operation_entry_exit_points</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">current_operation_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">last_points</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">current_points</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>

    <span class="c1"># Calculate distance: last_operation.exit → current_operation.entry</span>
    <span class="n">last_exit</span> <span class="o">=</span> <span class="n">last_points</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># (lat, lon)</span>
    <span class="n">current_entry</span> <span class="o">=</span> <span class="n">current_points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># (lat, lon)</span>

    <span class="n">distance_km</span> <span class="o">=</span> <span class="n">haversine_distance</span><span class="p">(</span><span class="n">last_exit</span><span class="p">,</span> <span class="n">current_entry</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">km_to_nm</span><span class="p">(</span><span class="n">distance_km</span><span class="p">)</span></div>



<span class="c1"># --- Core Scheduling Logic ---</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_resolve_station_details</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">CruiseConfig</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Finds a station, mooring, or transit definition by name.&quot;&quot;&quot;</span>
    <span class="c1"># Check stations (includes all point operations: CTD, mooring, etc.)</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">stations</span><span class="p">:</span>
        <span class="n">match</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">stations</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="s2">&quot;latitude&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="s2">&quot;position&quot;</span><span class="p">)):</span>
            <span class="c1"># Map operation type to legacy op_type for backward compatibility</span>
            <span class="c1"># This is a little confusing --&gt; these are how activities are filtered in latex_generator</span>
            <span class="n">op_type_mapping</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;CTD&quot;</span><span class="p">:</span> <span class="s2">&quot;station&quot;</span><span class="p">,</span>
                <span class="s2">&quot;water_sampling&quot;</span><span class="p">:</span> <span class="s2">&quot;station&quot;</span><span class="p">,</span>
                <span class="s2">&quot;calibration&quot;</span><span class="p">:</span> <span class="s2">&quot;station&quot;</span><span class="p">,</span>
                <span class="s2">&quot;mooring&quot;</span><span class="p">:</span> <span class="s2">&quot;mooring&quot;</span><span class="p">,</span>
                <span class="s2">&quot;survey&quot;</span><span class="p">:</span> <span class="s2">&quot;area&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">op_type</span> <span class="o">=</span> <span class="n">op_type_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">operation_type</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;station&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">match</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="n">match</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span>
                <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="n">match</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span>
                <span class="s2">&quot;depth&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="s2">&quot;operation_depth&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="s2">&quot;depth&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="ow">or</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s2">&quot;op_type&quot;</span><span class="p">:</span> <span class="n">op_type</span><span class="p">,</span>
                <span class="s2">&quot;manual_duration&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="s2">&quot;duration&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="ow">or</span> <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># Duration in minutes</span>
                <span class="s2">&quot;delay_start&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="s2">&quot;delay_start&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="s2">&quot;delay_start&quot;</span><span class="p">)</span>
                    <span class="k">else</span> <span class="mf">0.0</span>
                <span class="p">),</span>  <span class="c1"># Pre-operation delay in minutes</span>
                <span class="s2">&quot;delay_end&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="s2">&quot;delay_end&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="s2">&quot;delay_end&quot;</span><span class="p">)</span>
                    <span class="k">else</span> <span class="mf">0.0</span>
                <span class="p">),</span>  <span class="c1"># Post-operation delay in minutes</span>
                <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="p">(</span>
                        <span class="k">match</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">value</span>
                        <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">action</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">)</span>
                        <span class="k">else</span> <span class="n">match</span><span class="o">.</span><span class="n">action</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">action</span>
                    <span class="k">else</span> <span class="kc">None</span>
                <span class="p">),</span>
            <span class="p">}</span>

    <span class="c1"># Note: moorings are now included in stations list with operation_type=&quot;mooring&quot;</span>

    <span class="c1"># Check areas second</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">areas</span><span class="p">:</span>
        <span class="n">match</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">areas</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span> <span class="ow">and</span> <span class="n">match</span><span class="o">.</span><span class="n">corners</span><span class="p">:</span>
            <span class="c1"># For areas, calculate center point from corners</span>
            <span class="n">center_lat</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">corner</span><span class="o">.</span><span class="n">latitude</span> <span class="k">for</span> <span class="n">corner</span> <span class="ow">in</span> <span class="n">match</span><span class="o">.</span><span class="n">corners</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span>
                <span class="k">match</span><span class="o">.</span><span class="n">corners</span>
            <span class="p">)</span>
            <span class="n">center_lon</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">corner</span><span class="o">.</span><span class="n">longitude</span> <span class="k">for</span> <span class="n">corner</span> <span class="ow">in</span> <span class="n">match</span><span class="o">.</span><span class="n">corners</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span>
                <span class="k">match</span><span class="o">.</span><span class="n">corners</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">match</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="n">center_lat</span><span class="p">,</span>
                <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="n">center_lon</span><span class="p">,</span>
                <span class="s2">&quot;depth&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># Areas typically don&#39;t have depth</span>
                <span class="s2">&quot;op_type&quot;</span><span class="p">:</span> <span class="s2">&quot;area&quot;</span><span class="p">,</span>
                <span class="s2">&quot;manual_duration&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="s2">&quot;duration&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="ow">or</span> <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># Duration in minutes</span>
                <span class="s2">&quot;delay_start&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="s2">&quot;delay_start&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="s2">&quot;delay_start&quot;</span><span class="p">)</span>
                    <span class="k">else</span> <span class="mf">0.0</span>
                <span class="p">),</span>  <span class="c1"># Pre-operation delay in minutes</span>
                <span class="s2">&quot;delay_end&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="s2">&quot;delay_end&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="s2">&quot;delay_end&quot;</span><span class="p">)</span>
                    <span class="k">else</span> <span class="mf">0.0</span>
                <span class="p">),</span>  <span class="c1"># Post-operation delay in minutes</span>
                <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="p">(</span>
                        <span class="k">match</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">value</span>
                        <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">action</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">)</span>
                        <span class="k">else</span> <span class="n">match</span><span class="o">.</span><span class="n">action</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">action</span>
                    <span class="k">else</span> <span class="kc">None</span>
                <span class="p">),</span>
                <span class="s2">&quot;corners&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="n">corner</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="n">corner</span><span class="o">.</span><span class="n">longitude</span><span class="p">}</span>
                    <span class="k">for</span> <span class="n">corner</span> <span class="ow">in</span> <span class="n">match</span><span class="o">.</span><span class="n">corners</span>
                <span class="p">],</span>
            <span class="p">}</span>

    <span class="c1"># Check transits third</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">transits</span><span class="p">:</span>
        <span class="n">match</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">transits</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span> <span class="ow">and</span> <span class="n">match</span><span class="o">.</span><span class="n">route</span><span class="p">:</span>
            <span class="c1"># For transits, use the last point in the route as the &quot;position&quot;</span>
            <span class="n">first_point</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">route</span><span class="p">[</span>
                <span class="mi">0</span>
            <span class="p">]</span>  <span class="c1"># &lt;-- Capture start point for scientific transits</span>
            <span class="n">last_point</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">route</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># Calculate total route distance for proper transit duration</span>
            <span class="n">total_route_distance_km</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">route</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">start_point</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">route</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">end_point</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">route</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">segment_distance</span> <span class="o">=</span> <span class="n">haversine_distance</span><span class="p">(</span><span class="n">start_point</span><span class="p">,</span> <span class="n">end_point</span><span class="p">)</span>
                <span class="n">total_route_distance_km</span> <span class="o">+=</span> <span class="n">segment_distance</span>

            <span class="c1"># Convert to nautical miles and calculate duration</span>
            <span class="n">route_distance_nm</span> <span class="o">=</span> <span class="n">km_to_nm</span><span class="p">(</span><span class="n">total_route_distance_km</span><span class="p">)</span>
            <span class="c1"># Use transit-specific vessel speed if provided, otherwise use default</span>
            <span class="n">vessel_speed</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="s2">&quot;vessel_speed&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">config</span><span class="o">.</span><span class="n">default_vessel_speed</span>
            <span class="p">)</span>
            <span class="n">transit_time_h</span> <span class="o">=</span> <span class="n">route_distance_nm</span> <span class="o">/</span> <span class="n">vessel_speed</span>
            <span class="n">transit_duration_min</span> <span class="o">=</span> <span class="n">hours_to_minutes</span><span class="p">(</span><span class="n">transit_time_h</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">match</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="c1"># Use first point as position for distance calculations TO this transit</span>
                <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="n">first_point</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span>
                <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="n">first_point</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span>
                <span class="s2">&quot;start_lat&quot;</span><span class="p">:</span> <span class="n">first_point</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span>
                <span class="s2">&quot;start_lon&quot;</span><span class="p">:</span> <span class="n">first_point</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span>
                <span class="c1"># Add end point coordinates for position tracking after transit</span>
                <span class="s2">&quot;end_lat&quot;</span><span class="p">:</span> <span class="n">last_point</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span>
                <span class="s2">&quot;end_lon&quot;</span><span class="p">:</span> <span class="n">last_point</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span>
                <span class="s2">&quot;depth&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s2">&quot;op_type&quot;</span><span class="p">:</span> <span class="s2">&quot;transit&quot;</span><span class="p">,</span>
                <span class="s2">&quot;manual_duration&quot;</span><span class="p">:</span> <span class="n">transit_duration_min</span><span class="p">,</span>
                <span class="s2">&quot;route_distance_nm&quot;</span><span class="p">:</span> <span class="n">route_distance_nm</span><span class="p">,</span>  <span class="c1"># Store for debugging</span>
                <span class="s2">&quot;vessel_speed_kt&quot;</span><span class="p">:</span> <span class="n">vessel_speed</span><span class="p">,</span>  <span class="c1"># Include transit-specific vessel speed</span>
                <span class="s2">&quot;operation_type&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="s2">&quot;operation_type&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
                    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;value&quot;</span><span class="p">)</span>
                    <span class="k">else</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="s2">&quot;leg_name&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Will be set by calling code</span>
            <span class="p">}</span>

    <span class="k">return</span> <span class="kc">None</span>


<div class="viewcode-block" id="generate_timeline_legacy">
<a class="viewcode-back" href="../../../api/cruiseplan.calculators.html#cruiseplan.calculators.scheduler.generate_timeline_legacy">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_timeline_legacy</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">CruiseConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ActivityRecord</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    DEPRECATED: Legacy timeline generation for backward compatibility.</span>

<span class="sd">    Use generate_timeline_maritime() for new maritime architecture.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
        <span class="s2">&quot;generate_timeline() is deprecated. Use generate_timeline_maritime() for maritime architecture.&quot;</span><span class="p">,</span>
        <span class="ne">DeprecationWarning</span><span class="p">,</span>
        <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">_generate_timeline_legacy_impl</span><span class="p">(</span><span class="n">config</span><span class="p">)</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_generate_timeline_legacy_impl</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">CruiseConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ActivityRecord</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Legacy implementation moved to separate function.&quot;&quot;&quot;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a flattened, time-ordered list of all cruise activities.</span>

<span class="sd">    This function implements sequential scheduling logic where activities are</span>
<span class="sd">    processed in the order defined in the cruise configuration. Start times</span>
<span class="sd">    are calculated cumulatively based on operation durations and transit times.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    config : CruiseConfig</span>
<span class="sd">        Cruise configuration object containing legs, operations, and parameters.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of ActivityRecord</span>
<span class="sd">        Time-ordered list of all scheduled activities.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Phase 3a implementation: Strict sequential ordering based on YAML leg/sequence.</span>
<span class="sd">    Start time calculation: End Time (N) = Start Time (N) + Duration (N),</span>
<span class="sd">    Start Time (N+1) = End Time (N) + Transit Time (N -&gt; N+1).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">timeline</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ActivityRecord</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># 1. Initialize start time and duration calculator</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">cruiseplan.calculators.scheduler_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">_parse_start_datetime</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="n">_parse_start_datetime</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid start_date or start_time format in config: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="n">duration_calc</span> <span class="o">=</span> <span class="n">DurationCalculator</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="n">last_position</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GeoPoint</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># --- Step 2: Transit to Working Area ---</span>
    <span class="c1"># In legacy mode, use first leg&#39;s first waypoint if available</span>
    <span class="n">first_waypoint_name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">legs</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">legs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">first_leg</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">legs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">first_waypoint_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">first_leg</span><span class="p">,</span> <span class="s2">&quot;first_waypoint&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">first_station_details</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">_resolve_station_details</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">first_waypoint_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">first_waypoint_name</span>
        <span class="k">else</span> <span class="kc">None</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">first_station_details</span><span class="p">:</span>
        <span class="n">start_pos</span> <span class="o">=</span> <span class="n">_extract_coordinates</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">departure_port</span><span class="p">)</span>
        <span class="n">end_pos</span> <span class="o">=</span> <span class="n">GeoPoint</span><span class="p">(</span>
            <span class="n">latitude</span><span class="o">=</span><span class="n">first_station_details</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span>
            <span class="n">longitude</span><span class="o">=</span><span class="n">first_station_details</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="n">distance_km</span> <span class="o">=</span> <span class="n">haversine_distance</span><span class="p">(</span><span class="n">start_pos</span><span class="p">,</span> <span class="n">end_pos</span><span class="p">)</span>
        <span class="n">distance_nm</span> <span class="o">=</span> <span class="n">km_to_nm</span><span class="p">(</span><span class="n">distance_km</span><span class="p">)</span>
        <span class="n">transit_time_h</span> <span class="o">=</span> <span class="n">distance_nm</span> <span class="o">/</span> <span class="n">config</span><span class="o">.</span><span class="n">default_vessel_speed</span>
        <span class="n">transit_time_min</span> <span class="o">=</span> <span class="n">hours_to_minutes</span><span class="p">(</span><span class="n">transit_time_h</span><span class="p">)</span>

        <span class="n">timeline</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">ActivityRecord</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;activity&quot;</span><span class="p">:</span> <span class="s2">&quot;Transit&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;operation_type&quot;</span><span class="p">:</span> <span class="s2">&quot;transit&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Transit to working area: </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">departure_port</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">first_waypoint_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="n">end_pos</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span>
                    <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="n">end_pos</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span>
                    <span class="s2">&quot;depth&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;start_time&quot;</span><span class="p">:</span> <span class="n">current_time</span><span class="p">,</span>
                    <span class="s2">&quot;end_time&quot;</span><span class="p">:</span> <span class="n">current_time</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">transit_time_min</span><span class="p">),</span>
                    <span class="s2">&quot;duration_minutes&quot;</span><span class="p">:</span> <span class="n">transit_time_min</span><span class="p">,</span>
                    <span class="s2">&quot;transit_dist_nm&quot;</span><span class="p">:</span> <span class="n">distance_nm</span><span class="p">,</span>  <span class="c1"># Inter-operation distance</span>
                    <span class="s2">&quot;operation_dist_nm&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># No operation distance for pure navigation</span>
                    <span class="s2">&quot;vessel_speed_kt&quot;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">default_vessel_speed</span><span class="p">,</span>
                    <span class="s2">&quot;leg_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Transit_to_working_area&quot;</span><span class="p">,</span>
                    <span class="c1"># Added for completeness, though unused for pure navigation</span>
                    <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s2">&quot;start_lat&quot;</span><span class="p">:</span> <span class="n">start_pos</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span>
                    <span class="s2">&quot;start_lon&quot;</span><span class="p">:</span> <span class="n">start_pos</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">current_time</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">transit_time_min</span><span class="p">)</span>
        <span class="n">last_position</span> <span class="o">=</span> <span class="n">end_pos</span>

    <span class="c1"># --- Step 3: Extract and process all activities from legs ---</span>
    <span class="n">all_activities</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">leg</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">legs</span><span class="p">:</span>
        <span class="c1"># Extract activities from leg, including clusters</span>
        <span class="n">activity_names</span> <span class="o">=</span> <span class="n">_extract_activities_from_leg</span><span class="p">(</span><span class="n">leg</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">activity_names</span><span class="p">:</span>
            <span class="c1"># Try to resolve activity using specialized resolvers</span>
            <span class="n">details</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Try each resolver in order of specificity</span>
            <span class="n">details</span> <span class="o">=</span> <span class="n">_resolve_station_details</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">details</span><span class="p">:</span>
                <span class="n">details</span> <span class="o">=</span> <span class="n">_resolve_mooring_details</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">details</span><span class="p">:</span>
                <span class="n">details</span> <span class="o">=</span> <span class="n">_resolve_area_details</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">details</span><span class="p">:</span>
                <span class="n">details</span> <span class="o">=</span> <span class="n">_resolve_transit_details</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">details</span><span class="p">:</span>
                <span class="n">details</span> <span class="o">=</span> <span class="n">_resolve_port_details</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">details</span><span class="p">:</span>
                <span class="c1"># Add leg name to activity details</span>
                <span class="n">details</span><span class="p">[</span><span class="s2">&quot;leg_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">leg</span><span class="o">.</span><span class="n">name</span>
                <span class="n">all_activities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">details</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Could not resolve activity &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; in leg &#39;</span><span class="si">{</span><span class="n">leg</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="p">)</span>

    <span class="c1"># Process sequential activities (no complex Composite parsing yet)</span>
    <span class="n">current_leg_name</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Track leg changes for buffer time application</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">activity</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_activities</span><span class="p">):</span>

        <span class="c1"># Get the action early for use in ActivityRecord</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">activity</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Handle leg-level buffer time when transitioning between legs</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">cruiseplan.calculators.scheduler_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">_extract_leg_buffer_time</span>

        <span class="n">leg_name</span> <span class="o">=</span> <span class="n">activity</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;leg_name&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">current_leg_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">leg_name</span> <span class="o">!=</span> <span class="n">current_leg_name</span><span class="p">:</span>
            <span class="c1"># We&#39;ve moved to a new leg - check if previous leg has buffer time</span>
            <span class="n">previous_leg</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                <span class="p">(</span><span class="n">leg</span> <span class="k">for</span> <span class="n">leg</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">legs</span> <span class="k">if</span> <span class="n">leg</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">current_leg_name</span><span class="p">),</span> <span class="kc">None</span>
            <span class="p">)</span>

            <span class="n">buffer_time_min</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">_extract_leg_buffer_time</span><span class="p">(</span><span class="n">previous_leg</span><span class="p">)</span> <span class="k">if</span> <span class="n">previous_leg</span> <span class="k">else</span> <span class="mf">0.0</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">buffer_time_min</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Adding </span><span class="si">{</span><span class="n">buffer_time_min</span><span class="si">}</span><span class="s2"> min buffer time at end of leg &#39;</span><span class="si">{</span><span class="n">current_leg_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="p">)</span>
                <span class="n">current_time</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">buffer_time_min</span><span class="p">)</span>

        <span class="n">current_leg_name</span> <span class="o">=</span> <span class="n">leg_name</span>

        <span class="c1"># 3a. Calculate Transit time from last activity</span>
        <span class="c1"># For transits, calculate distance to the START of the route, not the end</span>
        <span class="n">target_position</span> <span class="o">=</span> <span class="n">_get_activity_entry_position</span><span class="p">(</span><span class="n">activity</span><span class="p">)</span>

        <span class="n">transit_time_min</span><span class="p">,</span> <span class="n">transit_dist_nm</span> <span class="o">=</span> <span class="n">_calculate_inter_operation_transit</span><span class="p">(</span>
            <span class="n">last_position</span><span class="p">,</span>
            <span class="n">target_position</span><span class="p">,</span>
            <span class="n">config</span><span class="o">.</span><span class="n">default_vessel_speed</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Add inter-operation transit record if distance &gt; threshold</span>
        <span class="k">if</span> <span class="n">transit_dist_nm</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>  <span class="c1"># Only add if meaningful distance</span>
            <span class="n">timeline</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;activity&quot;</span><span class="p">:</span> <span class="s2">&quot;Transit&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Transit to </span><span class="si">{</span><span class="n">activity</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;operation_type&quot;</span><span class="p">:</span> <span class="s2">&quot;Transit&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Pure navigation</span>
                    <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="n">target_position</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span>
                    <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="n">target_position</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span>
                    <span class="s2">&quot;depth&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;start_time&quot;</span><span class="p">:</span> <span class="n">current_time</span><span class="p">,</span>
                    <span class="s2">&quot;end_time&quot;</span><span class="p">:</span> <span class="n">current_time</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">transit_time_min</span><span class="p">),</span>
                    <span class="s2">&quot;duration_minutes&quot;</span><span class="p">:</span> <span class="n">transit_time_min</span><span class="p">,</span>
                    <span class="s2">&quot;transit_dist_nm&quot;</span><span class="p">:</span> <span class="n">transit_dist_nm</span><span class="p">,</span>  <span class="c1"># Inter-operation distance</span>
                    <span class="s2">&quot;operation_dist_nm&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># No operation distance for pure navigation</span>
                    <span class="s2">&quot;vessel_speed_kt&quot;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">default_vessel_speed</span><span class="p">,</span>
                    <span class="s2">&quot;leg_name&quot;</span><span class="p">:</span> <span class="n">activity</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;leg_name&quot;</span><span class="p">,</span> <span class="s2">&quot;Inter-operation Transit&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;start_lat&quot;</span><span class="p">:</span> <span class="n">last_position</span><span class="o">.</span><span class="n">latitude</span> <span class="k">if</span> <span class="n">last_position</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s2">&quot;start_lon&quot;</span><span class="p">:</span> <span class="n">last_position</span><span class="o">.</span><span class="n">longitude</span> <span class="k">if</span> <span class="n">last_position</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="c1"># Advance current_time after the inter-operation transit</span>
            <span class="n">current_time</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">transit_time_min</span><span class="p">)</span>

        <span class="c1"># For transit operations, we need to handle route logic differently</span>
        <span class="k">if</span> <span class="n">activity</span><span class="p">[</span><span class="s2">&quot;op_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;transit&quot;</span><span class="p">:</span>
            <span class="c1"># Find the original transit definition to get the route start</span>
            <span class="n">transit_def</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                <span class="p">(</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">transits</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">activity</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]),</span> <span class="kc">None</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">transit_def</span> <span class="ow">and</span> <span class="n">transit_def</span><span class="o">.</span><span class="n">route</span><span class="p">:</span>
                <span class="n">route_start</span> <span class="o">=</span> <span class="n">transit_def</span><span class="o">.</span><span class="n">route</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">route_end</span> <span class="o">=</span> <span class="n">transit_def</span><span class="o">.</span><span class="n">route</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                <span class="c1"># Calculate transit TO the route start (if not first activity)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">last_position</span><span class="p">:</span>
                    <span class="n">distance_km</span> <span class="o">=</span> <span class="n">haversine_distance</span><span class="p">(</span>
                        <span class="n">last_position</span><span class="p">,</span>
                        <span class="n">_extract_coordinates</span><span class="p">(</span><span class="n">route_start</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="n">transit_dist_nm</span> <span class="o">=</span> <span class="n">km_to_nm</span><span class="p">(</span><span class="n">distance_km</span><span class="p">)</span>
                    <span class="n">transit_time_h</span> <span class="o">=</span> <span class="n">transit_dist_nm</span> <span class="o">/</span> <span class="n">config</span><span class="o">.</span><span class="n">default_vessel_speed</span>
                    <span class="n">transit_time_min</span> <span class="o">=</span> <span class="n">hours_to_minutes</span><span class="p">(</span><span class="n">transit_time_h</span><span class="p">)</span>
                    <span class="n">current_time</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">transit_time_min</span><span class="p">)</span>

                <span class="c1"># Current position for this activity is the route END (for next operation&#39;s distance calculation)</span>
                <span class="n">current_pos</span> <span class="o">=</span> <span class="n">_extract_coordinates</span><span class="p">(</span><span class="n">route_end</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Fallback if route not found</span>
                <span class="n">current_pos</span> <span class="o">=</span> <span class="n">_get_activity_position</span><span class="p">(</span><span class="n">activity</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">last_position</span><span class="p">:</span>
                    <span class="n">distance_km</span> <span class="o">=</span> <span class="n">haversine_distance</span><span class="p">(</span><span class="n">last_position</span><span class="p">,</span> <span class="n">current_pos</span><span class="p">)</span>
                    <span class="n">transit_dist_nm</span> <span class="o">=</span> <span class="n">km_to_nm</span><span class="p">(</span><span class="n">distance_km</span><span class="p">)</span>
                    <span class="n">transit_time_h</span> <span class="o">=</span> <span class="n">transit_dist_nm</span> <span class="o">/</span> <span class="n">config</span><span class="o">.</span><span class="n">default_vessel_speed</span>
                    <span class="n">transit_time_min</span> <span class="o">=</span> <span class="n">hours_to_minutes</span><span class="p">(</span><span class="n">transit_time_h</span><span class="p">)</span>
                    <span class="n">current_time</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">transit_time_min</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Regular operations (stations, moorings)</span>
            <span class="n">current_pos</span> <span class="o">=</span> <span class="n">_get_activity_position</span><span class="p">(</span><span class="n">activity</span><span class="p">)</span>

            <span class="c1"># Note: Inter-operation transit time is now handled by explicit transit records above</span>
            <span class="c1"># so we don&#39;t add it to current_time here to avoid double-counting</span>

        <span class="c1"># 3b. Calculate Operation Duration</span>
        <span class="k">if</span> <span class="n">activity</span><span class="p">[</span><span class="s2">&quot;manual_duration&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">op_duration_min</span> <span class="o">=</span> <span class="n">activity</span><span class="p">[</span><span class="s2">&quot;manual_duration&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">activity</span><span class="p">[</span><span class="s2">&quot;op_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;station&quot;</span><span class="p">:</span>
            <span class="n">op_duration_min</span> <span class="o">=</span> <span class="n">duration_calc</span><span class="o">.</span><span class="n">calculate_ctd_time</span><span class="p">(</span><span class="n">activity</span><span class="p">[</span><span class="s2">&quot;depth&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">op_duration_min</span> <span class="o">=</span> <span class="mf">60.0</span>  <span class="c1"># Default fallback for non-CTD/Mooring ops</span>

        <span class="c1"># 3c. Handle Activity-Level Buffer Times</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">cruiseplan.calculators.scheduler_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">_extract_activity_delays</span>

        <span class="n">delay_start_min</span><span class="p">,</span> <span class="n">delay_end_min</span> <span class="o">=</span> <span class="n">_extract_activity_delays</span><span class="p">(</span><span class="n">activity</span><span class="p">)</span>

        <span class="c1"># Add delay_start to current_time (wait before operation begins)</span>
        <span class="k">if</span> <span class="n">delay_start_min</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">current_time</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">delay_start_min</span><span class="p">)</span>

        <span class="c1"># Total operation duration includes base duration + end delay</span>
        <span class="n">total_op_duration_min</span> <span class="o">=</span> <span class="n">op_duration_min</span> <span class="o">+</span> <span class="n">delay_end_min</span>

        <span class="c1"># Set operation distance: route distance for scientific transits, 0 for point operations</span>
        <span class="k">if</span> <span class="n">activity</span><span class="p">[</span><span class="s2">&quot;op_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;transit&quot;</span> <span class="ow">and</span> <span class="s2">&quot;route_distance_nm&quot;</span> <span class="ow">in</span> <span class="n">activity</span><span class="p">:</span>
            <span class="n">operation_distance</span> <span class="o">=</span> <span class="n">activity</span><span class="p">[</span><span class="s2">&quot;route_distance_nm&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">operation_distance</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># No operation distance for point operations</span>

        <span class="c1"># For scientific transits, transit_dist_nm should be 0 since inter-operation transit is separate</span>
        <span class="c1"># For point operations, transit_dist_nm should show the distance to reach this operation</span>
        <span class="k">if</span> <span class="n">activity</span><span class="p">[</span><span class="s2">&quot;op_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;transit&quot;</span><span class="p">:</span>
            <span class="n">transit_distance</span> <span class="o">=</span> <span class="p">(</span>
                <span class="mf">0.0</span>  <span class="c1"># Scientific transits: inter-operation distance handled separately</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">transit_distance</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">transit_dist_nm</span>  <span class="c1"># Point operations: show distance to reach here</span>
            <span class="p">)</span>

        <span class="n">timeline</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">ActivityRecord</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;activity&quot;</span><span class="p">:</span> <span class="n">activity</span><span class="p">[</span><span class="s2">&quot;op_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="p">(),</span>
                    <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">activity</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="n">current_pos</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span>  <span class="c1"># Use current_pos which accounts for route ends</span>
                    <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="n">current_pos</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span>
                    <span class="s2">&quot;depth&quot;</span><span class="p">:</span> <span class="n">activity</span><span class="p">[</span><span class="s2">&quot;depth&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;start_time&quot;</span><span class="p">:</span> <span class="n">current_time</span><span class="p">,</span>
                    <span class="s2">&quot;end_time&quot;</span><span class="p">:</span> <span class="n">current_time</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">total_op_duration_min</span><span class="p">),</span>
                    <span class="s2">&quot;duration_minutes&quot;</span><span class="p">:</span> <span class="n">total_op_duration_min</span><span class="p">,</span>
                    <span class="s2">&quot;transit_dist_nm&quot;</span><span class="p">:</span> <span class="n">transit_distance</span><span class="p">,</span>  <span class="c1"># Distance to reach this operation</span>
                    <span class="s2">&quot;operation_dist_nm&quot;</span><span class="p">:</span> <span class="n">operation_distance</span><span class="p">,</span>  <span class="c1"># Distance traveled during this operation</span>
                    <span class="s2">&quot;vessel_speed_kt&quot;</span><span class="p">:</span> <span class="n">activity</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;vessel_speed_kt&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">default_vessel_speed</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;leg_name&quot;</span><span class="p">:</span> <span class="n">activity</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;leg_name&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown_Leg&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;operation_type&quot;</span><span class="p">:</span> <span class="n">activity</span><span class="p">[</span><span class="s2">&quot;op_type&quot;</span><span class="p">],</span>
                    <span class="c1"># Propagate scientific/start coordinates</span>
                    <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>
                    <span class="s2">&quot;start_lat&quot;</span><span class="p">:</span> <span class="n">activity</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;start_lat&quot;</span><span class="p">,</span> <span class="n">current_pos</span><span class="o">.</span><span class="n">latitude</span><span class="p">),</span>
                    <span class="s2">&quot;start_lon&quot;</span><span class="p">:</span> <span class="n">activity</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;start_lon&quot;</span><span class="p">,</span> <span class="n">current_pos</span><span class="o">.</span><span class="n">longitude</span><span class="p">),</span>
                    <span class="s2">&quot;corners&quot;</span><span class="p">:</span> <span class="n">activity</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;corners&quot;</span><span class="p">,</span> <span class="p">[]),</span>  <span class="c1"># Area corner coordinates</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">current_time</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">total_op_duration_min</span><span class="p">)</span>
        <span class="n">last_position</span> <span class="o">=</span> <span class="n">current_pos</span>

    <span class="c1"># Add buffer time for the final leg if specified</span>
    <span class="k">if</span> <span class="n">current_leg_name</span><span class="p">:</span>
        <span class="n">final_leg</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
            <span class="p">(</span><span class="n">leg</span> <span class="k">for</span> <span class="n">leg</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">legs</span> <span class="k">if</span> <span class="n">leg</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">current_leg_name</span><span class="p">),</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="n">buffer_time_min</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="n">final_leg</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Only use buffer_time if it&#39;s actually defined (not a MagicMock)</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">final_leg</span><span class="p">,</span> <span class="s2">&quot;buffer_time&quot;</span><span class="p">):</span>
                    <span class="n">raw_buffer_time</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">final_leg</span><span class="p">,</span> <span class="s2">&quot;buffer_time&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="c1"># Check if it&#39;s a real value, not a MagicMock</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">raw_buffer_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">raw_buffer_time</span><span class="p">,</span> <span class="s2">&quot;_mock_name&quot;</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw_buffer_time</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span>
                    <span class="p">):</span>
                        <span class="n">buffer_time_min</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">raw_buffer_time</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
                <span class="n">buffer_time_min</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">if</span> <span class="n">buffer_time_min</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Adding </span><span class="si">{</span><span class="n">buffer_time_min</span><span class="si">}</span><span class="s2"> min buffer time at end of final leg &#39;</span><span class="si">{</span><span class="n">current_leg_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            <span class="p">)</span>
            <span class="n">current_time</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">buffer_time_min</span><span class="p">)</span>

    <span class="c1"># --- Step 4: Transit from Working Area ---</span>
    <span class="k">if</span> <span class="n">last_position</span><span class="p">:</span>
        <span class="n">end_pos</span> <span class="o">=</span> <span class="n">_extract_coordinates</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">arrival_port</span><span class="p">)</span>
        <span class="n">distance_km</span> <span class="o">=</span> <span class="n">haversine_distance</span><span class="p">(</span><span class="n">last_position</span><span class="p">,</span> <span class="n">end_pos</span><span class="p">)</span>
        <span class="n">distance_nm</span> <span class="o">=</span> <span class="n">km_to_nm</span><span class="p">(</span><span class="n">distance_km</span><span class="p">)</span>
        <span class="n">transit_time_h</span> <span class="o">=</span> <span class="n">distance_nm</span> <span class="o">/</span> <span class="n">config</span><span class="o">.</span><span class="n">default_vessel_speed</span>
        <span class="n">transit_time_min</span> <span class="o">=</span> <span class="n">hours_to_minutes</span><span class="p">(</span><span class="n">transit_time_h</span><span class="p">)</span>

        <span class="c1"># Demobilization (transit) starts after the last station ends</span>
        <span class="n">demob_start_time</span> <span class="o">=</span> <span class="n">current_time</span>
        <span class="n">demob_end_time</span> <span class="o">=</span> <span class="n">current_time</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">transit_time_min</span><span class="p">)</span>

        <span class="n">timeline</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">ActivityRecord</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;activity&quot;</span><span class="p">:</span> <span class="s2">&quot;Transit&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;operation_type&quot;</span><span class="p">:</span> <span class="s2">&quot;transit&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Transit from working area to </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">arrival_port</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="n">end_pos</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span>
                    <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="n">end_pos</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span>
                    <span class="s2">&quot;depth&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;start_time&quot;</span><span class="p">:</span> <span class="n">demob_start_time</span><span class="p">,</span>
                    <span class="s2">&quot;end_time&quot;</span><span class="p">:</span> <span class="n">demob_end_time</span><span class="p">,</span>
                    <span class="s2">&quot;duration_minutes&quot;</span><span class="p">:</span> <span class="n">transit_time_min</span><span class="p">,</span>
                    <span class="s2">&quot;transit_dist_nm&quot;</span><span class="p">:</span> <span class="n">distance_nm</span><span class="p">,</span>  <span class="c1"># Inter-operation distance</span>
                    <span class="s2">&quot;operation_dist_nm&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># No operation distance for pure navigation</span>
                    <span class="s2">&quot;vessel_speed_kt&quot;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">default_vessel_speed</span><span class="p">,</span>
                    <span class="s2">&quot;leg_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Transit_from_working_area&quot;</span><span class="p">,</span>
                    <span class="c1"># Added for completeness, though unused for pure navigation</span>
                    <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s2">&quot;start_lat&quot;</span><span class="p">:</span> <span class="n">last_position</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span>
                    <span class="s2">&quot;start_lon&quot;</span><span class="p">:</span> <span class="n">last_position</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">timeline</span>


<div class="viewcode-block" id="generate_timeline">
<a class="viewcode-back" href="../../../api/cruiseplan.calculators.html#cruiseplan.calculators.scheduler.generate_timeline">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_timeline</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">CruiseConfig</span><span class="p">,</span> <span class="n">cruise_obj</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ActivityRecord</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate comprehensive cruise timeline using maritime port-to-port architecture.</span>

<span class="sd">    This function implements the new maritime scheduling system with:</span>
<span class="sd">    - Port-to-port leg structure following nautical terminology</span>
<span class="sd">    - Cluster boundary management for operation shuffling</span>
<span class="sd">    - Proper parameter inheritance (Cruise → Leg → Cluster → Operations)</span>
<span class="sd">    - Realistic inter-leg transit routing</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    config : CruiseConfig</span>
<span class="sd">        Cruise configuration with validated maritime leg structure.</span>
<span class="sd">    cruise_obj : Cruise, optional</span>
<span class="sd">        Cruise object with runtime legs. If None, will create runtime legs from config.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[ActivityRecord]</span>
<span class="sd">        Complete timeline with port transits, leg operations, and cluster boundaries.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    This is the new implementation for maritime architecture. Uses runtime Leg objects</span>
<span class="sd">    from the Cruise class for proper port-to-port scheduling.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">cruiseplan.core.leg</span><span class="w"> </span><span class="kn">import</span> <span class="n">Leg</span>

    <span class="n">timeline</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ActivityRecord</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Initialize timing and calculators</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">cruiseplan.calculators.scheduler_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">_parse_start_datetime</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="n">_parse_start_datetime</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid start_date or start_time format in config: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="n">duration_calc</span> <span class="o">=</span> <span class="n">DurationCalculator</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="n">current_position</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GeoPoint</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Get runtime legs from cruise object or create them from config</span>
    <span class="k">if</span> <span class="n">cruise_obj</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cruise_obj</span><span class="p">,</span> <span class="s2">&quot;runtime_legs&quot;</span><span class="p">):</span>
        <span class="n">runtime_legs</span> <span class="o">=</span> <span class="n">cruise_obj</span><span class="o">.</span><span class="n">runtime_legs</span>
        <span class="n">leg_definitions</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">legs</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Fallback: create minimal Leg objects for backward compatibility</span>
        <span class="c1"># This handles test scenarios where full cruise object isn&#39;t available</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">cruiseplan.core.leg</span><span class="w"> </span><span class="kn">import</span> <span class="n">Leg</span>

        <span class="n">runtime_legs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">leg_def</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">legs</span> <span class="ow">or</span> <span class="p">[]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Try to create a basic Leg from the definition</span>
                <span class="n">runtime_leg</span> <span class="o">=</span> <span class="n">Leg</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">leg_def</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">departure_port</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">leg_def</span><span class="p">,</span> <span class="s2">&quot;departure_port&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="n">arrival_port</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">leg_def</span><span class="p">,</span> <span class="s2">&quot;arrival_port&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="n">description</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">leg_def</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="n">first_waypoint</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">leg_def</span><span class="p">,</span> <span class="s2">&quot;first_waypoint&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="n">last_waypoint</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">leg_def</span><span class="p">,</span> <span class="s2">&quot;last_waypoint&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="c1"># Copy leg-specific parameter overrides from definition</span>
                <span class="n">runtime_leg</span><span class="o">.</span><span class="n">vessel_speed</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">leg_def</span><span class="p">,</span> <span class="s2">&quot;vessel_speed&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">runtime_leg</span><span class="o">.</span><span class="n">turnaround_time</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">leg_def</span><span class="p">,</span> <span class="s2">&quot;turnaround_time&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">runtime_leg</span><span class="o">.</span><span class="n">distance_between_stations</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
                    <span class="n">leg_def</span><span class="p">,</span> <span class="s2">&quot;distance_between_stations&quot;</span><span class="p">,</span> <span class="kc">None</span>
                <span class="p">)</span>
                <span class="n">runtime_legs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">runtime_leg</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Failed to create runtime leg for &#39;</span><span class="si">{</span><span class="n">leg_def</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="c1"># Create a minimal mock leg for testing</span>
                <span class="n">runtime_leg</span> <span class="o">=</span> <span class="n">Leg</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">leg_def</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">departure_port</span><span class="o">=</span><span class="p">{</span>
                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Test_Port&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                        <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="n">arrival_port</span><span class="o">=</span><span class="p">{</span>
                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Test_Port&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                        <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">)</span>
                <span class="n">runtime_legs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">runtime_leg</span><span class="p">)</span>

        <span class="n">leg_definitions</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">legs</span>

    <span class="c1"># Process each leg using maritime port-to-port structure</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">leg_def</span><span class="p">,</span> <span class="n">runtime_leg</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">leg_definitions</span><span class="p">,</span> <span class="n">runtime_legs</span><span class="p">)):</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing leg &#39;</span><span class="si">{</span><span class="n">runtime_leg</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">runtime_leg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># 1. Add port departure transit if this is not the first leg</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Transit from previous leg&#39;s arrival port to current leg&#39;s departure port</span>
            <span class="n">prev_runtime_leg</span> <span class="o">=</span> <span class="n">runtime_legs</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">prev_arrival_pos</span> <span class="o">=</span> <span class="n">_extract_coordinates</span><span class="p">(</span><span class="n">prev_runtime_leg</span><span class="o">.</span><span class="n">arrival_port</span><span class="p">)</span>
            <span class="n">curr_departure_pos</span> <span class="o">=</span> <span class="n">_extract_coordinates</span><span class="p">(</span><span class="n">runtime_leg</span><span class="o">.</span><span class="n">departure_port</span><span class="p">)</span>

            <span class="c1"># Only add transit if ports are different and transit time &gt; 0</span>
            <span class="k">if</span> <span class="n">prev_arrival_pos</span> <span class="o">!=</span> <span class="n">curr_departure_pos</span><span class="p">:</span>
                <span class="c1"># Use leg&#39;s effective speed with parameter inheritance</span>
                <span class="n">effective_speed</span> <span class="o">=</span> <span class="n">runtime_leg</span><span class="o">.</span><span class="n">vessel_speed</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span>
                    <span class="n">config</span><span class="p">,</span> <span class="s2">&quot;default_vessel_speed&quot;</span><span class="p">,</span> <span class="mf">8.0</span>
                <span class="p">)</span>
                <span class="n">transit_time</span> <span class="o">=</span> <span class="n">_calculate_inter_port_transit</span><span class="p">(</span>
                    <span class="n">prev_arrival_pos</span><span class="p">,</span>
                    <span class="n">curr_departure_pos</span><span class="p">,</span>
                    <span class="n">effective_speed</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Only add if transit time is meaningful (&gt; 0)</span>
                <span class="k">if</span> <span class="n">transit_time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">timeline</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">ActivityRecord</span><span class="p">(</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;activity&quot;</span><span class="p">:</span> <span class="s2">&quot;Port_Transit&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Transit: </span><span class="si">{</span><span class="n">prev_runtime_leg</span><span class="o">.</span><span class="n">arrival_port</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> → </span><span class="si">{</span><span class="n">runtime_leg</span><span class="o">.</span><span class="n">departure_port</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="n">runtime_leg</span><span class="o">.</span><span class="n">departure_port</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span>
                                <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="n">runtime_leg</span><span class="o">.</span><span class="n">departure_port</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span>
                                <span class="s2">&quot;depth&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                                <span class="s2">&quot;start_time&quot;</span><span class="p">:</span> <span class="n">current_time</span><span class="p">,</span>
                                <span class="s2">&quot;end_time&quot;</span><span class="p">:</span> <span class="n">current_time</span>
                                <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">transit_time</span><span class="p">),</span>
                                <span class="s2">&quot;duration_minutes&quot;</span><span class="p">:</span> <span class="n">transit_time</span><span class="p">,</span>
                                <span class="s2">&quot;leg_name&quot;</span><span class="p">:</span> <span class="n">runtime_leg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                <span class="s2">&quot;op_type&quot;</span><span class="p">:</span> <span class="s2">&quot;transit&quot;</span><span class="p">,</span>
                            <span class="p">}</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">current_time</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">transit_time</span><span class="p">)</span>

        <span class="c1"># 2. Process leg departure from port to first operation</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">cruiseplan.calculators.scheduler_utils</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
            <span class="n">_calculate_port_to_operations_transit</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">transit_activity</span><span class="p">,</span> <span class="n">operation_pos</span> <span class="o">=</span> <span class="n">_calculate_port_to_operations_transit</span><span class="p">(</span>
            <span class="n">config</span><span class="p">,</span> <span class="n">runtime_leg</span><span class="p">,</span> <span class="n">leg_def</span><span class="p">,</span> <span class="n">current_time</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">transit_activity</span><span class="p">:</span>
            <span class="n">timeline</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ActivityRecord</span><span class="p">(</span><span class="n">transit_activity</span><span class="p">))</span>
            <span class="n">current_time</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">transit_activity</span><span class="p">[</span><span class="s2">&quot;duration_minutes&quot;</span><span class="p">])</span>
            <span class="n">current_position</span> <span class="o">=</span> <span class="n">operation_pos</span>

        <span class="c1"># 3. Process activities within leg using cluster boundaries</span>
        <span class="n">leg_activities</span> <span class="o">=</span> <span class="n">_process_leg_activities_with_clusters</span><span class="p">(</span>
            <span class="n">config</span><span class="p">,</span> <span class="n">runtime_leg</span><span class="p">,</span> <span class="n">leg_def</span><span class="p">,</span> <span class="n">duration_calc</span><span class="p">,</span> <span class="n">current_time</span><span class="p">,</span> <span class="n">current_position</span>
        <span class="p">)</span>

        <span class="n">timeline</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">leg_activities</span><span class="p">)</span>

        <span class="c1"># Update current time and position from last activity</span>
        <span class="k">if</span> <span class="n">leg_activities</span><span class="p">:</span>
            <span class="n">last_activity</span> <span class="o">=</span> <span class="n">leg_activities</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">current_time</span> <span class="o">=</span> <span class="n">last_activity</span><span class="p">[</span><span class="s2">&quot;end_time&quot;</span><span class="p">]</span>
            <span class="n">current_position</span> <span class="o">=</span> <span class="n">_get_activity_position</span><span class="p">(</span><span class="n">last_activity</span><span class="p">)</span>

        <span class="c1"># 4. Add transit from last operation to arrival port</span>
        <span class="c1"># Check for activities (either direct or extracted from clusters)</span>
        <span class="n">has_activities_for_arrival</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">leg_def</span><span class="o">.</span><span class="n">activities</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">bool</span><span class="p">(</span>
            <span class="n">_extract_activities_from_leg</span><span class="p">(</span><span class="n">leg_def</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">has_activities_for_arrival</span> <span class="ow">and</span> <span class="n">current_position</span><span class="p">:</span>
            <span class="n">arrival_pos</span> <span class="o">=</span> <span class="n">_extract_coordinates</span><span class="p">(</span><span class="n">runtime_leg</span><span class="o">.</span><span class="n">arrival_port</span><span class="p">)</span>
            <span class="n">operation_pos</span> <span class="o">=</span> <span class="n">current_position</span>

            <span class="c1"># Only add transit if positions are different</span>
            <span class="k">if</span> <span class="n">arrival_pos</span> <span class="o">!=</span> <span class="n">operation_pos</span><span class="p">:</span>
                <span class="c1"># Use leg&#39;s effective speed with parameter inheritance</span>
                <span class="n">effective_speed</span> <span class="o">=</span> <span class="n">runtime_leg</span><span class="o">.</span><span class="n">vessel_speed</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span>
                    <span class="n">config</span><span class="p">,</span> <span class="s2">&quot;default_vessel_speed&quot;</span><span class="p">,</span> <span class="mf">8.0</span>
                <span class="p">)</span>
                <span class="n">transit_time</span> <span class="o">=</span> <span class="n">_calculate_inter_port_transit</span><span class="p">(</span>
                    <span class="n">operation_pos</span><span class="p">,</span>
                    <span class="n">arrival_pos</span><span class="p">,</span>
                    <span class="n">effective_speed</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Calculate distance for CSV output</span>
                <span class="n">distance_km</span> <span class="o">=</span> <span class="n">haversine_distance</span><span class="p">(</span><span class="n">operation_pos</span><span class="p">,</span> <span class="n">arrival_pos</span><span class="p">)</span>
                <span class="n">distance_nm</span> <span class="o">=</span> <span class="n">km_to_nm</span><span class="p">(</span><span class="n">distance_km</span><span class="p">)</span>

                <span class="n">timeline</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">ActivityRecord</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;activity&quot;</span><span class="p">:</span> <span class="s2">&quot;Port_Arrival&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;operation_type&quot;</span><span class="p">:</span> <span class="s2">&quot;port_arrival&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Arrival: Operations to </span><span class="si">{</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">runtime_leg</span><span class="o">.</span><span class="n">arrival_port</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;display_name&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">runtime_leg</span><span class="o">.</span><span class="n">arrival_port</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">runtime_leg</span><span class="o">.</span><span class="n">arrival_port</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="n">runtime_leg</span><span class="o">.</span><span class="n">arrival_port</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span>
                            <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="n">runtime_leg</span><span class="o">.</span><span class="n">arrival_port</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span>
                            <span class="s2">&quot;depth&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                            <span class="s2">&quot;start_time&quot;</span><span class="p">:</span> <span class="n">current_time</span><span class="p">,</span>
                            <span class="s2">&quot;end_time&quot;</span><span class="p">:</span> <span class="n">current_time</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">transit_time</span><span class="p">),</span>
                            <span class="s2">&quot;duration_minutes&quot;</span><span class="p">:</span> <span class="n">transit_time</span><span class="p">,</span>
                            <span class="s2">&quot;transit_dist_nm&quot;</span><span class="p">:</span> <span class="n">distance_nm</span><span class="p">,</span>
                            <span class="s2">&quot;vessel_speed_kt&quot;</span><span class="p">:</span> <span class="n">effective_speed</span><span class="p">,</span>
                            <span class="s2">&quot;leg_name&quot;</span><span class="p">:</span> <span class="n">runtime_leg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="s2">&quot;op_type&quot;</span><span class="p">:</span> <span class="s2">&quot;transit&quot;</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">current_time</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">transit_time</span><span class="p">)</span>
                <span class="n">current_position</span> <span class="o">=</span> <span class="n">arrival_pos</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated maritime timeline with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">timeline</span><span class="p">)</span><span class="si">}</span><span class="s2"> activities&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">timeline</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_calculate_inter_port_transit</span><span class="p">(</span>
    <span class="n">start_pos</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">end_pos</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">vessel_speed</span><span class="p">:</span> <span class="nb">float</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate transit time between two geographic positions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    start_pos : tuple</span>
<span class="sd">        Starting position as (latitude, longitude).</span>
<span class="sd">    end_pos : tuple</span>
<span class="sd">        Ending position as (latitude, longitude).</span>
<span class="sd">    vessel_speed : float</span>
<span class="sd">        Vessel speed in knots.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Transit time in minutes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">distance_km</span> <span class="o">=</span> <span class="n">haversine_distance</span><span class="p">(</span><span class="n">start_pos</span><span class="p">,</span> <span class="n">end_pos</span><span class="p">)</span>
    <span class="n">distance_nm</span> <span class="o">=</span> <span class="n">km_to_nm</span><span class="p">(</span><span class="n">distance_km</span><span class="p">)</span>
    <span class="n">duration_hours</span> <span class="o">=</span> <span class="n">distance_nm</span> <span class="o">/</span> <span class="n">vessel_speed</span>
    <span class="k">return</span> <span class="n">duration_hours</span> <span class="o">*</span> <span class="mf">60.0</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_process_leg_activities_with_clusters</span><span class="p">(</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">CruiseConfig</span><span class="p">,</span>
    <span class="n">leg</span><span class="p">:</span> <span class="s2">&quot;Leg&quot;</span><span class="p">,</span>
    <span class="n">leg_def</span><span class="p">:</span> <span class="s2">&quot;LegDefinition&quot;</span><span class="p">,</span>
    <span class="n">duration_calc</span><span class="p">:</span> <span class="n">DurationCalculator</span><span class="p">,</span>
    <span class="n">start_time</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
    <span class="n">start_position</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GeoPoint</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ActivityRecord</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process activities within a leg using cluster boundary management.</span>

<span class="sd">    This function handles the complex logic of:</span>
<span class="sd">    - Resolving activities to operations</span>
<span class="sd">    - Applying cluster boundaries for reordering constraints</span>
<span class="sd">    - Calculating durations with parameter inheritance</span>
<span class="sd">    - Managing inter-operation transits within leg boundaries</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    config : CruiseConfig</span>
<span class="sd">        Cruise configuration.</span>
<span class="sd">    leg : Leg</span>
<span class="sd">        Runtime leg instance with clusters.</span>
<span class="sd">    leg_def : LegDefinition</span>
<span class="sd">        Original leg definition from config.</span>
<span class="sd">    duration_calc : DurationCalculator</span>
<span class="sd">        Duration calculator with cruise parameters.</span>
<span class="sd">    start_time : datetime</span>
<span class="sd">        Start time for first operation in leg.</span>
<span class="sd">    start_position : Optional[GeoPoint]</span>
<span class="sd">        Starting position for leg operations.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[ActivityRecord]</span>
<span class="sd">        List of activity records for this leg.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">activities</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">current_time</span> <span class="o">=</span> <span class="n">start_time</span>
    <span class="n">last_position</span> <span class="o">=</span> <span class="n">start_position</span>

    <span class="c1"># Extract activities from leg - waypoints are NOT included in execution</span>
    <span class="c1"># Waypoints (first_waypoint/last_waypoint) are used only for routing, not execution</span>
    <span class="n">activity_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">leg_def</span><span class="o">.</span><span class="n">activities</span><span class="p">:</span>
        <span class="c1"># Use direct activities if available</span>
        <span class="n">activity_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">leg_def</span><span class="o">.</span><span class="n">activities</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Extract activities from clusters</span>
        <span class="n">extracted_names</span> <span class="o">=</span> <span class="n">_extract_activities_from_leg</span><span class="p">(</span><span class="n">leg_def</span><span class="p">)</span>
        <span class="n">activity_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">extracted_names</span><span class="p">)</span>

    <span class="c1"># Note: Waypoints (first_waypoint/last_waypoint) are used only for transit planning</span>
    <span class="c1"># and route boundaries. They are NOT automatically added to the execution list.</span>

    <span class="c1"># For now, implement simple sequential processing</span>
    <span class="c1"># TODO: Implement cluster boundary processing with reordering capability</span>

    <span class="k">for</span> <span class="n">activity_def</span> <span class="ow">in</span> <span class="n">activity_list</span><span class="p">:</span>
        <span class="c1"># Extract activity name from activity definition</span>
        <span class="n">activity_name</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">activity_def</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">activity_def</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
            <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">activity_def</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Resolve activity details using specialized resolvers</span>
        <span class="n">details</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">details</span> <span class="o">=</span> <span class="n">_resolve_station_details</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">activity_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">details</span><span class="p">:</span>
            <span class="n">details</span> <span class="o">=</span> <span class="n">_resolve_mooring_details</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">activity_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">details</span><span class="p">:</span>
            <span class="n">details</span> <span class="o">=</span> <span class="n">_resolve_area_details</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">activity_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">details</span><span class="p">:</span>
            <span class="n">details</span> <span class="o">=</span> <span class="n">_resolve_transit_details</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">activity_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">details</span><span class="p">:</span>
            <span class="n">details</span> <span class="o">=</span> <span class="n">_resolve_port_details</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">activity_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">details</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Could not resolve activity &#39;</span><span class="si">{</span><span class="n">activity_name</span><span class="si">}</span><span class="s2">&#39; in leg &#39;</span><span class="si">{</span><span class="n">leg</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            <span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Calculate and add separate transit activity if needed</span>
        <span class="n">current_pos</span> <span class="o">=</span> <span class="n">GeoPoint</span><span class="p">(</span><span class="n">latitude</span><span class="o">=</span><span class="n">details</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span> <span class="n">longitude</span><span class="o">=</span><span class="n">details</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">last_position</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="n">last_position</span><span class="o">.</span><span class="n">latitude</span> <span class="o">!=</span> <span class="n">current_pos</span><span class="o">.</span><span class="n">latitude</span>
            <span class="ow">or</span> <span class="n">last_position</span><span class="o">.</span><span class="n">longitude</span> <span class="o">!=</span> <span class="n">current_pos</span><span class="o">.</span><span class="n">longitude</span>
        <span class="p">):</span>
            <span class="c1"># Calculate transit distance and time</span>
            <span class="n">transit_distance_km</span> <span class="o">=</span> <span class="n">haversine_distance</span><span class="p">(</span><span class="n">last_position</span><span class="p">,</span> <span class="n">current_pos</span><span class="p">)</span>
            <span class="n">transit_distance_nm</span> <span class="o">=</span> <span class="n">km_to_nm</span><span class="p">(</span><span class="n">transit_distance_km</span><span class="p">)</span>
            <span class="n">vessel_speed</span> <span class="o">=</span> <span class="n">leg</span><span class="o">.</span><span class="n">get_effective_speed</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">default_vessel_speed</span><span class="p">)</span>
            <span class="n">transit_time_h</span> <span class="o">=</span> <span class="n">transit_distance_nm</span> <span class="o">/</span> <span class="n">vessel_speed</span>
            <span class="n">transit_time_min</span> <span class="o">=</span> <span class="n">transit_time_h</span> <span class="o">*</span> <span class="mi">60</span>

            <span class="c1"># Add separate transit activity</span>
            <span class="n">activities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">ActivityRecord</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;activity&quot;</span><span class="p">:</span> <span class="s2">&quot;Transit&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;operation_type&quot;</span><span class="p">:</span> <span class="s2">&quot;transit&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Transit to </span><span class="si">{</span><span class="n">activity_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="n">current_pos</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span>
                        <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="n">current_pos</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span>
                        <span class="s2">&quot;depth&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                        <span class="s2">&quot;start_time&quot;</span><span class="p">:</span> <span class="n">current_time</span><span class="p">,</span>
                        <span class="s2">&quot;end_time&quot;</span><span class="p">:</span> <span class="n">current_time</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">transit_time_min</span><span class="p">),</span>
                        <span class="s2">&quot;duration_minutes&quot;</span><span class="p">:</span> <span class="n">transit_time_min</span><span class="p">,</span>
                        <span class="s2">&quot;transit_dist_nm&quot;</span><span class="p">:</span> <span class="n">transit_distance_nm</span><span class="p">,</span>
                        <span class="s2">&quot;vessel_speed_kt&quot;</span><span class="p">:</span> <span class="n">vessel_speed</span><span class="p">,</span>
                        <span class="s2">&quot;leg_name&quot;</span><span class="p">:</span> <span class="n">leg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="s2">&quot;op_type&quot;</span><span class="p">:</span> <span class="s2">&quot;transit&quot;</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">current_time</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">transit_time_min</span><span class="p">)</span>

        <span class="c1"># Add the main operation</span>
        <span class="n">operation_duration</span> <span class="o">=</span> <span class="n">duration_calc</span><span class="o">.</span><span class="n">calculate_ctd_time</span><span class="p">(</span><span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;depth&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;manual_duration&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">operation_duration</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s2">&quot;manual_duration&quot;</span><span class="p">]</span>

        <span class="c1"># Apply turnaround time using leg inheritance</span>
        <span class="n">turnaround_time</span> <span class="o">=</span> <span class="n">leg</span><span class="o">.</span><span class="n">get_effective_turnaround_time</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">turnaround_time</span><span class="p">)</span>

        <span class="n">activity_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;activity&quot;</span><span class="p">:</span> <span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;op_type&quot;</span><span class="p">,</span> <span class="s2">&quot;station&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">(),</span>
            <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">details</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
            <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="n">current_pos</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span>
            <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="n">current_pos</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span>
            <span class="s2">&quot;depth&quot;</span><span class="p">:</span> <span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;depth&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
            <span class="s2">&quot;start_time&quot;</span><span class="p">:</span> <span class="n">current_time</span><span class="p">,</span>
            <span class="s2">&quot;end_time&quot;</span><span class="p">:</span> <span class="n">current_time</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">operation_duration</span><span class="p">),</span>
            <span class="s2">&quot;duration_minutes&quot;</span><span class="p">:</span> <span class="n">operation_duration</span><span class="p">,</span>
            <span class="s2">&quot;transit_dist_nm&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># Transit distance now handled by separate transit activities</span>
            <span class="s2">&quot;operation_dist_nm&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># Default - will be updated for scientific transits</span>
            <span class="s2">&quot;leg_name&quot;</span><span class="p">:</span> <span class="n">leg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;op_type&quot;</span><span class="p">:</span> <span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;op_type&quot;</span><span class="p">,</span> <span class="s2">&quot;station&quot;</span><span class="p">),</span>
            <span class="s2">&quot;operation_type&quot;</span><span class="p">:</span> <span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;op_type&quot;</span><span class="p">,</span> <span class="s2">&quot;station&quot;</span>
            <span class="p">),</span>  <span class="c1"># For LaTeX compatibility</span>
            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="c1"># Add route distance for scientific transits</span>
        <span class="k">if</span> <span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;op_type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;transit&quot;</span> <span class="ow">and</span> <span class="s2">&quot;route_distance_nm&quot;</span> <span class="ow">in</span> <span class="n">details</span><span class="p">:</span>
            <span class="n">activity_data</span><span class="p">[</span><span class="s2">&quot;operation_dist_nm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s2">&quot;route_distance_nm&quot;</span><span class="p">]</span>

        <span class="n">activities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ActivityRecord</span><span class="p">(</span><span class="n">activity_data</span><span class="p">))</span>

        <span class="n">current_time</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">operation_duration</span> <span class="o">+</span> <span class="n">turnaround_time</span><span class="p">)</span>

        <span class="c1"># For transits, update position to end point, otherwise use current position</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;op_type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;transit&quot;</span>
            <span class="ow">and</span> <span class="s2">&quot;end_lat&quot;</span> <span class="ow">in</span> <span class="n">details</span>
            <span class="ow">and</span> <span class="s2">&quot;end_lon&quot;</span> <span class="ow">in</span> <span class="n">details</span>
        <span class="p">):</span>
            <span class="n">last_position</span> <span class="o">=</span> <span class="n">GeoPoint</span><span class="p">(</span>
                <span class="n">latitude</span><span class="o">=</span><span class="n">details</span><span class="p">[</span><span class="s2">&quot;end_lat&quot;</span><span class="p">],</span> <span class="n">longitude</span><span class="o">=</span><span class="n">details</span><span class="p">[</span><span class="s2">&quot;end_lon&quot;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">last_position</span> <span class="o">=</span> <span class="n">current_pos</span>

    <span class="k">return</span> <span class="n">activities</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_calculate_inter_operation_transit</span><span class="p">(</span><span class="n">last_pos</span><span class="p">,</span> <span class="n">current_pos</span><span class="p">,</span> <span class="n">vessel_speed_kt</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate transit time and distance between two operations.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">last_pos</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">current_pos</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>

    <span class="c1"># Use existing route_distance function with a 2-point route</span>
    <span class="n">distance_km</span> <span class="o">=</span> <span class="n">route_distance</span><span class="p">([</span><span class="n">last_pos</span><span class="p">,</span> <span class="n">current_pos</span><span class="p">])</span>

    <span class="c1"># Use existing DurationCalculator.calculate_transit_time</span>
    <span class="c1"># Note: You&#39;ll need to create a DurationCalculator instance or pass it in</span>
    <span class="c1"># For now, we can calculate directly:</span>
    <span class="n">distance_nm</span> <span class="o">=</span> <span class="n">km_to_nm</span><span class="p">(</span><span class="n">distance_km</span><span class="p">)</span>
    <span class="n">transit_time_h</span> <span class="o">=</span> <span class="n">distance_nm</span> <span class="o">/</span> <span class="n">vessel_speed_kt</span> <span class="k">if</span> <span class="n">vessel_speed_kt</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
    <span class="n">transit_time_min</span> <span class="o">=</span> <span class="n">transit_time_h</span> <span class="o">*</span> <span class="mi">60</span>

    <span class="k">return</span> <span class="n">transit_time_min</span><span class="p">,</span> <span class="n">distance_nm</span>


<span class="c1"># ===== CLI Integration Function =====</span>


<div class="viewcode-block" id="generate_cruise_schedule">
<a class="viewcode-back" href="../../../api/cruiseplan.calculators.html#cruiseplan.calculators.scheduler.generate_cruise_schedule">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_cruise_schedule</span><span class="p">(</span>
    <span class="n">config_path</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">,</span>
    <span class="n">formats</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">validate_depths</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">selected_leg</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">derive_netcdf</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">bathy_source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;etopo2022&quot;</span><span class="p">,</span>
    <span class="n">bathy_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span>
    <span class="n">bathy_stride</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_basename</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate comprehensive cruise schedules from YAML configuration.</span>

<span class="sd">    This is the main function called by the CLI that orchestrates the entire</span>
<span class="sd">    schedule generation process, including timeline creation and output formatting.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    config_path : str or Path</span>
<span class="sd">        Path to input YAML configuration file.</span>
<span class="sd">    output_dir : str or Path</span>
<span class="sd">        Output directory for generated schedule files.</span>
<span class="sd">    formats : list of str, optional</span>
<span class="sd">        List of output formats to generate. Default is [&quot;html&quot;, &quot;csv&quot;].</span>
<span class="sd">    validate_depths : bool, optional</span>
<span class="sd">        Whether to validate depths during generation. Default is False.</span>
<span class="sd">    selected_leg : str, optional</span>
<span class="sd">        If specified, only generate schedule for this leg. Default is None.</span>
<span class="sd">    derive_netcdf : bool, optional</span>
<span class="sd">        If True and NetCDF format is enabled, generate specialized NetCDF files</span>
<span class="sd">        (_points.nc, _lines.nc, _areas.nc) in addition to master schedule. Default is False.</span>
<span class="sd">    bathy_source : str, optional</span>
<span class="sd">        Bathymetry dataset to use for PNG map generation. Default is &quot;etopo2022&quot;.</span>
<span class="sd">    bathy_dir : str, optional</span>
<span class="sd">        Directory containing bathymetry data for PNG maps. Default is &quot;data&quot;.</span>
<span class="sd">    bathy_stride : int, optional</span>
<span class="sd">        Bathymetry contour stride for PNG maps. Default is 10.</span>
<span class="sd">    figsize : list of float, optional</span>
<span class="sd">        Figure size for PNG maps in inches [width, height]. Default is [12.0, 8.0].</span>
<span class="sd">    output_basename : str, optional</span>
<span class="sd">        Base filename for output files. If None, uses cruise name from config.</span>
<span class="sd">        Default is None.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Dictionary with generation summary and statistics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">cruiseplan.core.cruise</span><span class="w"> </span><span class="kn">import</span> <span class="n">Cruise</span>

    <span class="c1"># Set defaults</span>
    <span class="k">if</span> <span class="n">formats</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">formats</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;html&quot;</span><span class="p">,</span> <span class="s2">&quot;csv&quot;</span><span class="p">]</span>

    <span class="c1"># Load cruise configuration</span>
    <span class="n">cruise</span> <span class="o">=</span> <span class="n">Cruise</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">cruise</span><span class="o">.</span><span class="n">config</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded cruise: </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">cruise_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">description</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Description: </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">description</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Validate depths if requested</span>
    <span class="n">warnings</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">validate_depths</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Validating station depths...&quot;</span><span class="p">)</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">cruiseplan.core.validation</span><span class="w"> </span><span class="kn">import</span> <span class="n">validate_configuration_file</span>

        <span class="n">success</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">depth_warnings</span> <span class="o">=</span> <span class="n">validate_configuration_file</span><span class="p">(</span>
            <span class="n">config_path</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">config_path</span><span class="p">),</span>
            <span class="n">check_depths</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">tolerance</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
            <span class="n">bathymetry_source</span><span class="o">=</span><span class="s2">&quot;etopo2022&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Configuration validation failed: </span><span class="si">{</span><span class="n">errors</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">depth_warnings</span><span class="p">)</span>

    <span class="c1"># Filter legs if specified</span>
    <span class="n">legs_to_process</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">legs</span>
    <span class="k">if</span> <span class="n">selected_leg</span><span class="p">:</span>
        <span class="n">legs_to_process</span> <span class="o">=</span> <span class="p">[</span><span class="n">leg</span> <span class="k">for</span> <span class="n">leg</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">legs</span> <span class="k">if</span> <span class="n">leg</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">selected_leg</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">legs_to_process</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Leg &#39;</span><span class="si">{</span><span class="n">selected_leg</span><span class="si">}</span><span class="s2">&#39; not found in configuration&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing selected leg: </span><span class="si">{</span><span class="n">selected_leg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Generate timeline using maritime architecture with runtime legs</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating activity timeline...&quot;</span><span class="p">)</span>
    <span class="n">timeline</span> <span class="o">=</span> <span class="n">generate_timeline</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">cruise_obj</span><span class="o">=</span><span class="n">cruise</span><span class="p">)</span>

    <span class="c1"># Filter timeline by selected leg if specified</span>
    <span class="k">if</span> <span class="n">selected_leg</span><span class="p">:</span>
        <span class="n">timeline</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">activity</span>
            <span class="k">for</span> <span class="n">activity</span> <span class="ow">in</span> <span class="n">timeline</span>
            <span class="k">if</span> <span class="n">activity</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;leg_name&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">selected_leg</span>
        <span class="p">]</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Generated </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">timeline</span><span class="p">)</span><span class="si">}</span><span class="s2"> activities&quot;</span><span class="p">)</span>

    <span class="c1"># Calculate summary statistics</span>
    <span class="n">total_duration_hours</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nb">sum</span><span class="p">(</span><span class="n">activity</span><span class="p">[</span><span class="s2">&quot;duration_minutes&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">activity</span> <span class="ow">in</span> <span class="n">timeline</span><span class="p">)</span> <span class="o">/</span> <span class="mf">60.0</span>
    <span class="p">)</span>
    <span class="n">total_distance_nm</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
        <span class="n">activity</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;transit_dist_nm&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">activity</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;operation_dist_nm&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">activity</span> <span class="ow">in</span> <span class="n">timeline</span>
    <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Total schedule duration: </span><span class="si">{</span><span class="n">total_duration_hours</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> hours&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Total distance: </span><span class="si">{</span><span class="n">total_distance_nm</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> nm&quot;</span><span class="p">)</span>

    <span class="c1"># Generate output files</span>
    <span class="n">formats_generated</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">output_files</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Create output directory</span>
    <span class="n">output_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
    <span class="n">output_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Determine base filename for all output files</span>
    <span class="k">if</span> <span class="n">output_basename</span><span class="p">:</span>
        <span class="c1"># Use user-provided base name</span>
        <span class="n">base_name</span> <span class="o">=</span> <span class="n">output_basename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Use cruise name as default</span>
        <span class="n">base_name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">cruise_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>

    <span class="n">leg_suffix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">selected_leg</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">selected_leg</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="n">base_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}{</span><span class="n">leg_suffix</span><span class="si">}</span><span class="s2">_schedule&quot;</span>

    <span class="k">for</span> <span class="n">format_name</span> <span class="ow">in</span> <span class="n">formats</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Generating </span><span class="si">{</span><span class="n">format_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> output...&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">format_name</span> <span class="o">==</span> <span class="s2">&quot;html&quot;</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">cruiseplan.output.html_generator</span><span class="w"> </span><span class="kn">import</span> <span class="n">generate_html_schedule</span>

                <span class="n">output_file</span> <span class="o">=</span> <span class="n">output_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_filename</span><span class="si">}</span><span class="s2">.html&quot;</span>
                <span class="n">generate_html_schedule</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">timeline</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    HTML schedule: </span><span class="si">{</span><span class="n">base_filename</span><span class="si">}</span><span class="s2">_summary.html&quot;</span><span class="p">)</span>
                <span class="n">formats_generated</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;html&quot;</span><span class="p">)</span>
                <span class="n">output_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">format_name</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">cruiseplan.output.csv_generator</span><span class="w"> </span><span class="kn">import</span> <span class="n">generate_csv_schedule</span>

                <span class="n">output_file</span> <span class="o">=</span> <span class="n">output_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_filename</span><span class="si">}</span><span class="s2">.csv&quot;</span>
                <span class="n">generate_csv_schedule</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">timeline</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    CSV schedule: </span><span class="si">{</span><span class="n">output_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">formats_generated</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;csv&quot;</span><span class="p">)</span>
                <span class="n">output_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">format_name</span> <span class="o">==</span> <span class="s2">&quot;latex&quot;</span><span class="p">:</span>
                <span class="n">output_file</span> <span class="o">=</span> <span class="n">_generate_latex_schedule</span><span class="p">(</span>
                    <span class="n">timeline</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">base_filename</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    LaTeX tables: </span><span class="si">{</span><span class="n">base_filename</span><span class="si">}</span><span class="s2">_tables.tex&quot;</span><span class="p">)</span>
                <span class="n">formats_generated</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;latex&quot;</span><span class="p">)</span>
                <span class="n">output_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">format_name</span> <span class="o">==</span> <span class="s2">&quot;netcdf&quot;</span><span class="p">:</span>
                <span class="n">output_file</span> <span class="o">=</span> <span class="n">_generate_netcdf_schedule</span><span class="p">(</span>
                    <span class="n">timeline</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">base_filename</span><span class="p">,</span> <span class="n">derive_netcdf</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    netCDF output: </span><span class="si">{</span><span class="n">output_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">formats_generated</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;netcdf&quot;</span><span class="p">)</span>
                <span class="n">output_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">format_name</span> <span class="o">==</span> <span class="s2">&quot;png&quot;</span><span class="p">:</span>
                <span class="c1"># Set default figsize if not provided</span>
                <span class="k">if</span> <span class="n">figsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">figsize</span> <span class="o">=</span> <span class="p">[</span><span class="mf">12.0</span><span class="p">,</span> <span class="mf">8.0</span><span class="p">]</span>

                <span class="n">output_file</span> <span class="o">=</span> <span class="n">_generate_timeline_png_map</span><span class="p">(</span>
                    <span class="n">timeline</span><span class="p">,</span>
                    <span class="n">cruise</span><span class="p">,</span>
                    <span class="n">output_path</span><span class="p">,</span>
                    <span class="n">base_filename</span><span class="p">,</span>
                    <span class="n">bathy_source</span><span class="o">=</span><span class="n">bathy_source</span><span class="p">,</span>
                    <span class="n">bathy_dir</span><span class="o">=</span><span class="n">bathy_dir</span><span class="p">,</span>
                    <span class="n">bathy_stride</span><span class="o">=</span><span class="n">bathy_stride</span><span class="p">,</span>
                    <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">output_file</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    PNG map: </span><span class="si">{</span><span class="n">output_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">formats_generated</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;png&quot;</span><span class="p">)</span>
                    <span class="n">output_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown format &#39;</span><span class="si">{</span><span class="n">format_name</span><span class="si">}</span><span class="s2">&#39; - skipping&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to generate </span><span class="si">{</span><span class="n">format_name</span><span class="si">}</span><span class="s2"> output: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to generate </span><span class="si">{</span><span class="n">format_name</span><span class="si">}</span><span class="s2"> format: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Return summary</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;total_activities&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">timeline</span><span class="p">),</span>
        <span class="s2">&quot;total_duration_hours&quot;</span><span class="p">:</span> <span class="n">total_duration_hours</span><span class="p">,</span>
        <span class="s2">&quot;total_distance_nm&quot;</span><span class="p">:</span> <span class="n">total_distance_nm</span><span class="p">,</span>
        <span class="s2">&quot;formats_generated&quot;</span><span class="p">:</span> <span class="n">formats_generated</span><span class="p">,</span>
        <span class="s2">&quot;output_files&quot;</span><span class="p">:</span> <span class="n">output_files</span><span class="p">,</span>
        <span class="s2">&quot;warnings&quot;</span><span class="p">:</span> <span class="n">warnings</span><span class="p">,</span>
        <span class="s2">&quot;cruise_name&quot;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">cruise_name</span><span class="p">,</span>
        <span class="s2">&quot;selected_leg&quot;</span><span class="p">:</span> <span class="n">selected_leg</span><span class="p">,</span>
    <span class="p">}</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_generate_latex_schedule</span><span class="p">(</span><span class="n">timeline</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">base_filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate LaTeX schedule output.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">cruiseplan.output.latex_generator</span><span class="w"> </span><span class="kn">import</span> <span class="n">generate_latex_tables</span>

        <span class="c1"># Use existing LaTeX generator function with correct parameters</span>
        <span class="n">latex_files</span> <span class="o">=</span> <span class="n">generate_latex_tables</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">timeline</span><span class="p">,</span> <span class="n">output_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">latex_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">latex_files</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;LaTeX generator not available - skipping LaTeX output&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_generate_netcdf_schedule</span><span class="p">(</span>
    <span class="n">timeline</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">base_filename</span><span class="p">,</span> <span class="n">derive_netcdf</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate NetCDF schedule output.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">cruiseplan.output.netcdf_generator</span><span class="w"> </span><span class="kn">import</span> <span class="n">NetCDFGenerator</span>

        <span class="n">netcdf_gen</span> <span class="o">=</span> <span class="n">NetCDFGenerator</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">derive_netcdf</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    Generating all NetCDF files (master + specialized)...&quot;</span><span class="p">)</span>
            <span class="c1"># Generate all files including derived ones</span>
            <span class="n">output_files</span> <span class="o">=</span> <span class="n">netcdf_gen</span><span class="o">.</span><span class="n">generate_all_netcdf_outputs</span><span class="p">(</span>
                <span class="n">config</span><span class="p">,</span> <span class="n">timeline</span><span class="p">,</span> <span class="n">output_path</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Generated </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">output_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> NetCDF files:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">output_files</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      • </span><span class="si">{</span><span class="n">file_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">output_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Return schedule file as main output</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Generate only master schedule file</span>
            <span class="n">output_file</span> <span class="o">=</span> <span class="n">output_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_filename</span><span class="si">}</span><span class="s2">.nc&quot;</span>
            <span class="n">netcdf_gen</span><span class="o">.</span><span class="n">generate_master_schedule</span><span class="p">(</span><span class="n">timeline</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">output_file</span>

    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;NetCDF generator not available - skipping NetCDF output&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_generate_timeline_png_map</span><span class="p">(</span>
    <span class="n">timeline</span><span class="p">,</span>
    <span class="n">cruise</span><span class="p">,</span>
    <span class="n">output_path</span><span class="p">,</span>
    <span class="n">base_filename</span><span class="p">,</span>
    <span class="n">bathy_source</span><span class="o">=</span><span class="s2">&quot;etopo2022&quot;</span><span class="p">,</span>
    <span class="n">bathy_dir</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span>
    <span class="n">bathy_stride</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate PNG map from timeline data showing scheduled sequence.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">cruiseplan.output.map_generator</span><span class="w"> </span><span class="kn">import</span> <span class="n">generate_map_from_timeline</span>

        <span class="n">output_file</span> <span class="o">=</span> <span class="n">output_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_filename</span><span class="si">}</span><span class="s2">_map.png&quot;</span>

        <span class="c1"># Set default figsize if not provided</span>
        <span class="k">if</span> <span class="n">figsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">figsize</span> <span class="o">=</span> <span class="p">[</span><span class="mf">12.0</span><span class="p">,</span> <span class="mf">8.0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">generate_map_from_timeline</span><span class="p">(</span>
            <span class="n">timeline</span><span class="o">=</span><span class="n">timeline</span><span class="p">,</span>
            <span class="n">output_file</span><span class="o">=</span><span class="n">output_file</span><span class="p">,</span>
            <span class="n">bathy_source</span><span class="o">=</span><span class="n">bathy_source</span><span class="p">,</span>
            <span class="n">bathy_dir</span><span class="o">=</span><span class="n">bathy_dir</span><span class="p">,</span>
            <span class="n">bathy_stride</span><span class="o">=</span><span class="n">bathy_stride</span><span class="p">,</span>
            <span class="n">figsize</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">figsize</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">figsize</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">figsize</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">cruise</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;PNG map generator not available - skipping PNG output&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PNG map generation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_extract_activities_from_leg</span><span class="p">(</span><span class="n">leg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract all activity names from a leg, including those in clusters.</span>

<span class="sd">    Processes in priority order:</span>
<span class="sd">    1. Direct activities in leg.activities</span>
<span class="sd">    2. Clusters containing activities, sequences, or stations</span>
<span class="sd">    3. Direct sequence in leg.sequence (deprecated)</span>
<span class="sd">    4. Direct stations in leg.stations (deprecated)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    leg : LegDefinition</span>
<span class="sd">        Leg definition from configuration.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of str</span>
<span class="sd">        Ordered list of activity names to process.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">activity_names</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Priority 1: Direct activities (new unified field)</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="nb">hasattr</span><span class="p">(</span><span class="n">leg</span><span class="p">,</span> <span class="s2">&quot;activities&quot;</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">leg</span><span class="o">.</span><span class="n">activities</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">leg</span><span class="o">.</span><span class="n">activities</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="p">):</span>
        <span class="k">for</span> <span class="n">activity</span> <span class="ow">in</span> <span class="n">leg</span><span class="o">.</span><span class="n">activities</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">activity</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">activity_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">activity</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">activity</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">activity</span><span class="p">:</span>
                <span class="n">activity_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">activity</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">activity</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">):</span>
                <span class="n">activity_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">activity</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="c1"># Priority 2: Process clusters (only if not None/empty)</span>
    <span class="k">elif</span> <span class="p">(</span>
        <span class="nb">hasattr</span><span class="p">(</span><span class="n">leg</span><span class="p">,</span> <span class="s2">&quot;clusters&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">leg</span><span class="o">.</span><span class="n">clusters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">leg</span><span class="o">.</span><span class="n">clusters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="p">):</span>
        <span class="n">cluster_activities_found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">leg</span><span class="o">.</span><span class="n">clusters</span><span class="p">:</span>
            <span class="c1"># Process cluster activities (new format)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="s2">&quot;activities&quot;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">cluster</span><span class="o">.</span><span class="n">activities</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">activities</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="p">):</span>
                <span class="k">for</span> <span class="n">activity</span> <span class="ow">in</span> <span class="n">cluster</span><span class="o">.</span><span class="n">activities</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">activity</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="n">activity_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">activity</span><span class="p">)</span>
                        <span class="n">cluster_activities_found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">activity</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">activity</span><span class="p">:</span>
                        <span class="n">activity_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">activity</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
                        <span class="n">cluster_activities_found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">activity</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">):</span>
                        <span class="n">activity_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">activity</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="n">cluster_activities_found</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># Process cluster sequence (deprecated)</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="s2">&quot;sequence&quot;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">cluster</span><span class="o">.</span><span class="n">sequence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">sequence</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Cluster &#39;</span><span class="si">{</span><span class="n">cluster</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; uses deprecated &#39;sequence&#39; field. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Use &#39;activities&#39; field instead. Support will be removed in v0.3.0.&quot;</span><span class="p">,</span>
                    <span class="ne">DeprecationWarning</span><span class="p">,</span>
                    <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cluster</span><span class="o">.</span><span class="n">sequence</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="n">activity_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                        <span class="n">cluster_activities_found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">):</span>
                        <span class="n">activity_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="n">cluster_activities_found</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># Process cluster stations (deprecated)</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="s2">&quot;stations&quot;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">cluster</span><span class="o">.</span><span class="n">stations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">stations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Cluster &#39;</span><span class="si">{</span><span class="n">cluster</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; uses deprecated &#39;stations&#39; field. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Use &#39;activities&#39; field instead. Support will be removed in v0.3.0.&quot;</span><span class="p">,</span>
                    <span class="ne">DeprecationWarning</span><span class="p">,</span>
                    <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">cluster</span><span class="o">.</span><span class="n">stations</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">station</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="n">activity_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">station</span><span class="p">)</span>
                        <span class="n">cluster_activities_found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">station</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">):</span>
                        <span class="n">activity_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">station</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="n">cluster_activities_found</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Priority 3: Direct sequence (deprecated, fallback if no activities found)</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">activity_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">leg</span><span class="p">,</span> <span class="s2">&quot;sequence&quot;</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">leg</span><span class="o">.</span><span class="n">sequence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">leg</span><span class="o">.</span><span class="n">sequence</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Leg &#39;</span><span class="si">{</span><span class="n">leg</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; uses deprecated &#39;sequence&#39; field. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Use &#39;activities&#39; field instead. Support will be removed in v0.3.0.&quot;</span><span class="p">,</span>
            <span class="ne">DeprecationWarning</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">leg</span><span class="o">.</span><span class="n">sequence</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">activity_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">):</span>
                <span class="n">activity_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="c1"># Priority 4: Direct stations (deprecated, final fallback)</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">activity_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">leg</span><span class="p">,</span> <span class="s2">&quot;stations&quot;</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">leg</span><span class="o">.</span><span class="n">stations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">leg</span><span class="o">.</span><span class="n">stations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Leg &#39;</span><span class="si">{</span><span class="n">leg</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; uses deprecated &#39;stations&#39; field. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Use &#39;activities&#39; field instead. Support will be removed in v0.3.0.&quot;</span><span class="p">,</span>
            <span class="ne">DeprecationWarning</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">leg</span><span class="o">.</span><span class="n">stations</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">station</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">activity_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">station</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">station</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">):</span>
                <span class="n">activity_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">station</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">activity_names</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_resolve_transit_details</span><span class="p">(</span>
    <span class="n">config</span><span class="p">:</span> <span class="s2">&quot;CruiseConfig&quot;</span><span class="p">,</span> <span class="n">transit_name</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Resolve transit details from configuration.</span>

<span class="sd">    Similar to _resolve_station_details but for transits.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    config : CruiseConfig</span>
<span class="sd">        Cruise configuration object.</span>
<span class="sd">    transit_name : str</span>
<span class="sd">        Name of the transit to resolve.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict or None</span>
<span class="sd">        Transit details dictionary or None if not found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;transits&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">transits</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">transit</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">transits</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">transit</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">transit_name</span><span class="p">:</span>
            <span class="n">details</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">transit</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;op_type&quot;</span><span class="p">:</span> <span class="s2">&quot;transit&quot;</span><span class="p">,</span>
                <span class="s2">&quot;operation_type&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">transit</span><span class="p">,</span> <span class="s2">&quot;operation_type&quot;</span><span class="p">,</span> <span class="s2">&quot;underway&quot;</span><span class="p">),</span>
                <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">transit</span><span class="p">,</span> <span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="s2">&quot;comment&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">transit</span><span class="p">,</span> <span class="s2">&quot;comment&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="p">}</span>

            <span class="c1"># Process route if available</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">transit</span><span class="p">,</span> <span class="s2">&quot;route&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">transit</span><span class="o">.</span><span class="n">route</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">transit</span><span class="o">.</span><span class="n">route</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">transit</span><span class="o">.</span><span class="n">route</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                <span class="c1"># Extract coordinates</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="s2">&quot;latitude&quot;</span><span class="p">):</span>
                    <span class="n">details</span><span class="p">[</span><span class="s2">&quot;start_lat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start</span><span class="o">.</span><span class="n">latitude</span>
                    <span class="n">details</span><span class="p">[</span><span class="s2">&quot;start_lon&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start</span><span class="o">.</span><span class="n">longitude</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">details</span><span class="p">[</span><span class="s2">&quot;start_lat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="n">start</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lat&quot;</span><span class="p">))</span>
                    <span class="n">details</span><span class="p">[</span><span class="s2">&quot;start_lon&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;longitude&quot;</span><span class="p">,</span> <span class="n">start</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lon&quot;</span><span class="p">))</span>

                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="s2">&quot;latitude&quot;</span><span class="p">):</span>
                    <span class="n">details</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">end</span><span class="o">.</span><span class="n">latitude</span>
                    <span class="n">details</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">end</span><span class="o">.</span><span class="n">longitude</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">details</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">end</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lat&quot;</span><span class="p">))</span>
                    <span class="n">details</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">end</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;longitude&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lon&quot;</span><span class="p">))</span>

                <span class="c1"># Calculate route distance if needed</span>
                <span class="k">if</span> <span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;start_lat&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lat&quot;</span><span class="p">):</span>
                    <span class="n">start_pos</span> <span class="o">=</span> <span class="n">GeoPoint</span><span class="p">(</span>
                        <span class="n">latitude</span><span class="o">=</span><span class="n">details</span><span class="p">[</span><span class="s2">&quot;start_lat&quot;</span><span class="p">],</span> <span class="n">longitude</span><span class="o">=</span><span class="n">details</span><span class="p">[</span><span class="s2">&quot;start_lon&quot;</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">end_pos</span> <span class="o">=</span> <span class="n">GeoPoint</span><span class="p">(</span>
                        <span class="n">latitude</span><span class="o">=</span><span class="n">details</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span> <span class="n">longitude</span><span class="o">=</span><span class="n">details</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">distance_km</span> <span class="o">=</span> <span class="n">haversine_distance</span><span class="p">(</span><span class="n">start_pos</span><span class="p">,</span> <span class="n">end_pos</span><span class="p">)</span>
                    <span class="n">details</span><span class="p">[</span><span class="s2">&quot;route_distance_km&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">distance_km</span>
                    <span class="n">details</span><span class="p">[</span><span class="s2">&quot;route_distance_nm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">km_to_nm</span><span class="p">(</span><span class="n">distance_km</span><span class="p">)</span>

            <span class="c1"># Check if this needs expansion (CTD section)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="n">transit</span><span class="p">,</span> <span class="s2">&quot;operation_type&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;CTD&quot;</span>
                <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">transit</span><span class="p">,</span> <span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;section&quot;</span>
            <span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Transit &#39;</span><span class="si">{</span><span class="n">transit_name</span><span class="si">}</span><span class="s2">&#39; is a CTD section that should be &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;expanded. Run &#39;cruiseplan enrich --expand-sections&#39; first.&quot;</span>
                <span class="p">)</span>

            <span class="k">return</span> <span class="n">details</span>

    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_resolve_mooring_details</span><span class="p">(</span>
    <span class="n">config</span><span class="p">:</span> <span class="s2">&quot;CruiseConfig&quot;</span><span class="p">,</span> <span class="n">mooring_name</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Resolve mooring details from configuration.</span>

<span class="sd">    Specifically handles mooring operations with deployment/recovery actions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    config : CruiseConfig</span>
<span class="sd">        Cruise configuration object.</span>
<span class="sd">    mooring_name : str</span>
<span class="sd">        Name of the mooring to resolve.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict or None</span>
<span class="sd">        Mooring details dictionary or None if not found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;stations&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">stations</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">stations</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">station</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">mooring_name</span>
            <span class="ow">and</span> <span class="n">station</span><span class="o">.</span><span class="n">operation_type</span>
            <span class="ow">and</span> <span class="n">station</span><span class="o">.</span><span class="n">operation_type</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;mooring&quot;</span>
        <span class="p">):</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">station</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="n">station</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span>
                <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="n">station</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span>
                <span class="s2">&quot;depth&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="n">station</span><span class="p">,</span> <span class="s2">&quot;operation_depth&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">station</span><span class="p">,</span> <span class="s2">&quot;depth&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="ow">or</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s2">&quot;op_type&quot;</span><span class="p">:</span> <span class="s2">&quot;mooring&quot;</span><span class="p">,</span>
                <span class="s2">&quot;manual_duration&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">station</span><span class="p">,</span> <span class="s2">&quot;duration&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="ow">or</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s2">&quot;delay_start&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">station</span><span class="p">,</span> <span class="s2">&quot;delay_start&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
                <span class="s2">&quot;delay_end&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">station</span><span class="p">,</span> <span class="s2">&quot;delay_end&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
                <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="p">(</span>
                        <span class="n">station</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">value</span>
                        <span class="k">if</span> <span class="n">station</span><span class="o">.</span><span class="n">action</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">station</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">)</span>
                        <span class="k">else</span> <span class="n">station</span><span class="o">.</span><span class="n">action</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">station</span><span class="o">.</span><span class="n">action</span>
                    <span class="k">else</span> <span class="kc">None</span>
                <span class="p">),</span>
                <span class="s2">&quot;mooring_type&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">station</span><span class="p">,</span> <span class="s2">&quot;mooring_type&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">}</span>

    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_resolve_area_details</span><span class="p">(</span>
    <span class="n">config</span><span class="p">:</span> <span class="s2">&quot;CruiseConfig&quot;</span><span class="p">,</span> <span class="n">area_name</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Resolve area details from configuration.</span>

<span class="sd">    Handles area-based operations like surveys and monitoring.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    config : CruiseConfig</span>
<span class="sd">        Cruise configuration object.</span>
<span class="sd">    area_name : str</span>
<span class="sd">        Name of the area to resolve.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict or None</span>
<span class="sd">        Area details dictionary or None if not found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;areas&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">areas</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">area</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">areas</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">area</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">area_name</span> <span class="ow">and</span> <span class="n">area</span><span class="o">.</span><span class="n">corners</span><span class="p">:</span>
            <span class="c1"># Calculate center point from corners</span>
            <span class="n">center_lat</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">corner</span><span class="o">.</span><span class="n">latitude</span> <span class="k">for</span> <span class="n">corner</span> <span class="ow">in</span> <span class="n">area</span><span class="o">.</span><span class="n">corners</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span>
                <span class="n">area</span><span class="o">.</span><span class="n">corners</span>
            <span class="p">)</span>
            <span class="n">center_lon</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">corner</span><span class="o">.</span><span class="n">longitude</span> <span class="k">for</span> <span class="n">corner</span> <span class="ow">in</span> <span class="n">area</span><span class="o">.</span><span class="n">corners</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span>
                <span class="n">area</span><span class="o">.</span><span class="n">corners</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">area</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="n">center_lat</span><span class="p">,</span>
                <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="n">center_lon</span><span class="p">,</span>
                <span class="s2">&quot;depth&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># Areas typically don&#39;t have specific depth</span>
                <span class="s2">&quot;op_type&quot;</span><span class="p">:</span> <span class="s2">&quot;area&quot;</span><span class="p">,</span>
                <span class="s2">&quot;manual_duration&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">area</span><span class="p">,</span> <span class="s2">&quot;duration&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="ow">or</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s2">&quot;delay_start&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">area</span><span class="p">,</span> <span class="s2">&quot;delay_start&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
                <span class="s2">&quot;delay_end&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">area</span><span class="p">,</span> <span class="s2">&quot;delay_end&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
                <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="p">(</span>
                        <span class="n">area</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">value</span>
                        <span class="k">if</span> <span class="n">area</span><span class="o">.</span><span class="n">action</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">area</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">)</span>
                        <span class="k">else</span> <span class="n">area</span><span class="o">.</span><span class="n">action</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">area</span><span class="o">.</span><span class="n">action</span>
                    <span class="k">else</span> <span class="kc">None</span>
                <span class="p">),</span>
                <span class="s2">&quot;corners&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="n">corner</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="n">corner</span><span class="o">.</span><span class="n">longitude</span><span class="p">}</span>
                    <span class="k">for</span> <span class="n">corner</span> <span class="ow">in</span> <span class="n">area</span><span class="o">.</span><span class="n">corners</span>
                <span class="p">],</span>
                <span class="s2">&quot;area_km2&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">area</span><span class="p">,</span> <span class="s2">&quot;area_km2&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">}</span>

    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_resolve_port_details</span><span class="p">(</span>
    <span class="n">config</span><span class="p">:</span> <span class="s2">&quot;CruiseConfig&quot;</span><span class="p">,</span> <span class="n">port_name</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Resolve port details from configuration or global port registry.</span>

<span class="sd">    Handles port references for leg departure/arrival points.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    config : CruiseConfig</span>
<span class="sd">        Cruise configuration object.</span>
<span class="sd">    port_name : str</span>
<span class="sd">        Name of the port to resolve (can be global reference like &#39;port_bergen&#39;).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict or None</span>
<span class="sd">        Port details dictionary or None if not found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">cruiseplan.core.validation</span><span class="w"> </span><span class="kn">import</span> <span class="n">PortDefinition</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">cruiseplan.utils.global_ports</span><span class="w"> </span><span class="kn">import</span> <span class="n">resolve_port_reference</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Try to resolve as global port reference or custom port definition</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">port_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;port_&quot;</span><span class="p">):</span>
            <span class="c1"># Global port reference</span>
            <span class="n">port_def</span> <span class="o">=</span> <span class="n">resolve_port_reference</span><span class="p">(</span><span class="n">port_name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;ports&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">ports</span><span class="p">:</span>
            <span class="c1"># Check for custom port definitions in config</span>
            <span class="n">port_def</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">ports</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">port_name</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">port_def</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Try to resolve as global reference</span>
                <span class="n">port_def</span> <span class="o">=</span> <span class="n">resolve_port_reference</span><span class="p">(</span><span class="n">port_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Try to resolve as global reference</span>
            <span class="n">port_def</span> <span class="o">=</span> <span class="n">resolve_port_reference</span><span class="p">(</span><span class="n">port_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">port_def</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">port_def</span><span class="p">,</span> <span class="n">PortDefinition</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">port_def</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="n">port_def</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span>
                <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="n">port_def</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span>
                <span class="s2">&quot;op_type&quot;</span><span class="p">:</span> <span class="s2">&quot;port&quot;</span><span class="p">,</span>
                <span class="s2">&quot;timezone&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">port_def</span><span class="p">,</span> <span class="s2">&quot;timezone&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">port_def</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">}</span>

    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
        <span class="c1"># Port reference not found in global registry</span>
        <span class="k">pass</span>

    <span class="k">return</span> <span class="kc">None</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>